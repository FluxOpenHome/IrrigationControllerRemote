name: Build ESPHome Firmware

on:
  push:
    branches: [main]
    paths:
      - '**.yaml'
      - 'firmware/**'

concurrency:
  group: build-firmware
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.device.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        device:
          - name: irrigation-remote
            file: irrigationcontrollerremote.yaml
            manifest: manifest.json
            friendly: "Irrigation Remote"
          - name: irrigation-remote-big
            file: irrigationcontrollerremoteBig.yaml
            manifest: manifestBig.json
            friendly: "Irrigation Remote Big"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build firmware
        uses: esphome/build-action@v7
        id: esphome-build
        with:
          yaml-file: ${{ matrix.device.file }}

      - name: Get version from YAML
        id: version
        run: |
          VERSION=$(grep 'software_version:' ${{ matrix.device.file }} | head -1 | sed 's/.*"\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Firmware version: $VERSION"

      - name: Rename firmware files
        run: |
          mkdir -p output
          mkdir -p firmware
          BUILD_DIR="${{ steps.esphome-build.outputs.name }}"
          VERSION="${{ steps.version.outputs.version }}"
          NAME="${{ matrix.device.name }}"

          # OTA bin → output/ (for GitHub Release)
          for file in "$BUILD_DIR"/*.ota.bin; do
            [ -f "$file" ] && cp "$file" "output/${NAME}-${VERSION}.ota.bin"
          done

          # Factory bin → firmware/ (to commit to repo)
          for file in "$BUILD_DIR"/*.factory.bin; do
            [ -f "$file" ] && cp "$file" "firmware/${NAME}-${VERSION}.factory.bin"
          done

          # Generate MD5 hash for OTA bin
          for file in output/*.ota.bin; do
            [ -f "$file" ] && md5sum "$file" | awk '{print $1}' > "${file}.md5"
          done

          echo "Release files:"
          ls -la output/
          echo "Repo files:"
          ls -la firmware/

      - name: Update manifest
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          NAME="${{ matrix.device.name }}"
          TAG="v${VERSION}"
          MANIFEST="${{ matrix.device.manifest }}"
          FRIENDLY="${{ matrix.device.friendly }}"
          MD5=$(cat output/${NAME}-${VERSION}.ota.bin.md5)

          cat > ${MANIFEST} << EOF
          {
            "name": "${FRIENDLY}",
            "version": "${VERSION}",
            "builds": [
              {
                "chipFamily": "ESP32-S3",
                "ota": {
                  "md5": "${MD5}",
                  "path": "https://github.com/FluxOpenHome/IrrigationControllerRemote/releases/download/${TAG}/${NAME}-${VERSION}.ota.bin",
                  "release_url": "https://github.com/FluxOpenHome/IrrigationControllerRemote/releases/tag/${TAG}",
                  "summary": "Update ${VERSION}"
                }
              }
            ]
          }
          EOF
          # Remove leading whitespace from heredoc
          sed -i 's/^          //' ${MANIFEST}
          echo "Updated ${MANIFEST}:"
          cat ${MANIFEST}

      - name: Commit factory bin and manifest to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add firmware/ ${{ matrix.device.manifest }}
          git diff --cached --quiet || git commit -m "Build: ${NAME} factory bin v${VERSION}

          Auto-built from ${{ github.sha }}"
          git pull --rebase origin main
          git push
        env:
          NAME: ${{ matrix.device.name }}
          VERSION: ${{ steps.version.outputs.version }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.device.name }}-firmware
          path: |
            output/*.bin
            output/*.md5

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: "v${{ steps.version.outputs.version }}"
          body: |
            Automated firmware build

            - Version: `${{ steps.version.outputs.version }}`
            - Commit: ${{ github.sha }}

            **Files:**
            - `.ota.bin` — OTA update (in release)
            - `.ota.bin.md5` — MD5 checksum for OTA bin
            - `.factory.bin` — Full flash (in `firmware/` folder)
          files: |
            output/*.ota.bin
            output/*.ota.bin.md5
          make_latest: true
