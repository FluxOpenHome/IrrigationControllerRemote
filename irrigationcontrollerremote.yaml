# Irrigation Controller Remote - M5Stack Dial (StampS3)
# Remote control for the FluxOpenHome Irrigation Controller
# v2.0.0 — Pure HA mirror entity architecture (no HTTP)
# All entities are optimistic templates. HA automations sync
# bidirectionally between this remote and the controller.

substitutions:
  name: "irrigation-remote"
  friendly_name: "Irrigation Remote"
  software_version: "2.0.0"

esphome:
  name: "${name}"
  friendly_name: "${friendly_name}"
  name_add_mac_suffix: true
  project:
    name: "FluxOpenHome.IrrigationRemote"
    version: "${software_version}"
  platformio_options:
    board_build.flash_mode: dio
    board_build.flash_size: 8MB
  on_boot:
    priority: -100
    then:
      - lambda: |-
          // Create per-page focus groups for encoder navigation
          lv_group_t *g_status   = lv_group_create();
          lv_group_t *g_zones    = lv_group_create();
          lv_group_t *g_dur      = lv_group_create();
          lv_group_t *g_sched    = lv_group_create();
          lv_group_t *g_time_ed  = lv_group_create();
          lv_group_t *g_settings = lv_group_create();

          // page_status
          lv_group_add_obj(g_status, id(btn_start_stop));
          lv_group_add_obj(g_status, id(btn_pause));
          lv_group_add_obj(g_status, id(btn_auto_adv));
          lv_group_add_obj(g_status, id(btn_goto_zones));
          lv_group_add_obj(g_status, id(btn_goto_schedule));
          lv_group_add_obj(g_status, id(btn_goto_settings));

          // page_zones
          lv_group_add_obj(g_zones, id(btn_zone_1));
          lv_group_add_obj(g_zones, id(btn_zone_2));
          lv_group_add_obj(g_zones, id(btn_zone_3));
          lv_group_add_obj(g_zones, id(btn_zone_4));
          lv_group_add_obj(g_zones, id(btn_zone_prev));
          lv_group_add_obj(g_zones, id(btn_zone_next));
          lv_group_add_obj(g_zones, id(btn_zone_run));
          lv_group_add_obj(g_zones, id(btn_goto_dur));
          lv_group_add_obj(g_zones, id(btn_zones_back));

          // page_duration
          lv_group_add_obj(g_dur, id(btn_dur_zone_prev));
          lv_group_add_obj(g_dur, id(btn_dur_zone_next));
          lv_group_add_obj(g_dur, id(slider_duration));
          lv_group_add_obj(g_dur, id(btn_dur_set));
          lv_group_add_obj(g_dur, id(btn_dur_back));

          // page_schedule
          lv_group_add_obj(g_sched, id(btn_sched_toggle));
          lv_group_add_obj(g_sched, id(btn_day_mon));
          lv_group_add_obj(g_sched, id(btn_day_tue));
          lv_group_add_obj(g_sched, id(btn_day_wed));
          lv_group_add_obj(g_sched, id(btn_day_thu));
          lv_group_add_obj(g_sched, id(btn_day_fri));
          lv_group_add_obj(g_sched, id(btn_day_sat));
          lv_group_add_obj(g_sched, id(btn_day_sun));
          lv_group_add_obj(g_sched, id(btn_goto_time_edit));
          lv_group_add_obj(g_sched, id(btn_sched_back));

          // page_time_edit
          lv_group_add_obj(g_time_ed, id(btn_slot_prev));
          lv_group_add_obj(g_time_ed, id(btn_slot_next));
          lv_group_add_obj(g_time_ed, id(btn_hour_up));
          lv_group_add_obj(g_time_ed, id(btn_hour_down));
          lv_group_add_obj(g_time_ed, id(btn_min_up));
          lv_group_add_obj(g_time_ed, id(btn_min_down));
          lv_group_add_obj(g_time_ed, id(btn_ampm));
          lv_group_add_obj(g_time_ed, id(btn_time_set));
          lv_group_add_obj(g_time_ed, id(btn_time_clear));
          lv_group_add_obj(g_time_ed, id(btn_time_back));

          // page_settings
          lv_group_add_obj(g_settings, id(slider_zone_count));
          lv_group_add_obj(g_settings, id(btn_auto_detect));
          lv_group_add_obj(g_settings, id(btn_12hr_toggle));
          lv_group_add_obj(g_settings, id(btn_settings_save));
          lv_group_add_obj(g_settings, id(btn_settings_back));

          // Store group pointers
          id(grp_status)    = (void*)g_status;
          id(grp_zones)     = (void*)g_zones;
          id(grp_duration)  = (void*)g_dur;
          id(grp_schedule)  = (void*)g_sched;
          id(grp_time_edit) = (void*)g_time_ed;
          id(grp_settings)  = (void*)g_settings;

          // Find encoder indev and assign initial group
          lv_indev_t *enc = nullptr;
          while ((enc = lv_indev_get_next(enc)) != nullptr) {
            if (lv_indev_get_type(enc) == LV_INDEV_TYPE_ENCODER) {
              id(enc_indev) = (void*)enc;
              lv_indev_set_group(enc, g_status);
              break;
            }
          }
      - light.turn_on:
          id: lcd_backlight
          brightness: 100%
      - lvgl.page.show:
          id: page_splash
          animation: NONE
      - delay: 3s
      - lvgl.page.show:
          id: page_status
          animation: NONE

esp32:
  variant: esp32s3
  board: esp32-s3-devkitc-1
  flash_size: 8MB
  framework:
    type: esp-idf

logger:
  level: DEBUG

api:
  id: api_server
  on_client_connected:
    - lvgl.label.update:
        id: lbl_connection
        text: "HA Connected"
    - lambda: |-
        lv_obj_set_style_text_color(id(lbl_connection), lv_color_hex(0x00E676), 0);
  on_client_disconnected:
    - lvgl.label.update:
        id: lbl_connection
        text: "HA Disconnected"
    - lambda: |-
        lv_obj_set_style_text_color(id(lbl_connection), lv_color_hex(0xFF1744), 0);

ota:
  - id: ota_component
    platform: esphome
  - id: ota_http_request
    platform: http_request

# HTTP request component for firmware updates
http_request:
  id: http_request_component
  buffer_size_rx: 8192
  buffer_size_tx: 4096
  follow_redirects: true
  timeout: 30s
  verify_ssl: true

# Firmware update from GitHub
update:
  - platform: http_request
    id: firmware_update
    name: "Firmware Update"
    source: https://raw.githubusercontent.com/FluxOpenHome/IrrigationControllerRemote/main/manifest.json

wifi:
  id: wifi_component
  ap:
    ssid: "${name}"
  on_connect:
    - lambda: 'id(wifi_connected) = true;'
    - lvgl.label.update:
        id: lbl_wifi
        text: "WiFi: ON"
    - lambda: |-
        lv_obj_set_style_text_color(id(lbl_wifi), lv_color_hex(0x00E676), 0);
  on_disconnect:
    - lambda: 'id(wifi_connected) = false;'
    - lvgl.label.update:
        id: lbl_wifi
        text: "WiFi: OFF"
    - lambda: |-
        lv_obj_set_style_text_color(id(lbl_wifi), lv_color_hex(0xFF1744), 0);

captive_portal:

esp32_improv:
  authorizer: none

improv_serial:

dashboard_import:
  package_import_url: github://FluxOpenHome/IrrigationControllerRemote/irrigationcontrollerremote.yaml@main
  import_full_config: true

web_server:
  port: 80

# ──────────────────────────────────────────────
# M5Stack Dial (StampS3) Hardware
# ──────────────────────────────────────────────

i2c:
  - id: internal_i2c
    sda: GPIO11
    scl: GPIO12

spi:
  - id: spi_bus
    clk_pin: GPIO6
    mosi_pin: GPIO5

output:
  - platform: ledc
    pin: GPIO9
    id: lcd_backlight_output
    channel: 0

display:
  - platform: ili9xxx
    model: GC9A01A
    cs_pin: GPIO7
    reset_pin: GPIO8
    dc_pin: GPIO4
    id: dial_lcd
    invert_colors: true
    auto_clear_enabled: false
    update_interval: never

touchscreen:
  - platform: ft5x06
    id: touch
    i2c_id: internal_i2c
    address: 0x38

light:
  - platform: monochromatic
    id: lcd_backlight
    name: "LCD Backlight"
    icon: "mdi:television"
    entity_category: config
    output: lcd_backlight_output
    restore_mode: RESTORE_DEFAULT_ON
    default_transition_length: 0s

# ──────────────────────────────────────────────
# Globals
# ──────────────────────────────────────────────

globals:
  # Encoder focus groups (per-page)
  - id: enc_indev
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_status
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_zones
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_duration
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_schedule
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_time_edit
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_settings
    type: void*
    restore_value: no
    initial_value: 'nullptr'

  # WiFi state
  - id: wifi_connected
    type: bool
    restore_value: no
    initial_value: 'false'

  # Zone count (configurable, persists)
  - id: zone_count
    type: int
    restore_value: yes
    initial_value: '8'

  # Zone states bitmask (bit N = zone N+1 active)
  - id: zone_states
    type: uint32_t
    restore_value: no
    initial_value: '0'

  # Zone page navigation
  - id: zone_page_offset
    type: int
    restore_value: no
    initial_value: '0'
  - id: last_selected_zone
    type: int
    restore_value: no
    initial_value: '1'

  # Duration page
  - id: dur_selected_zone
    type: int
    restore_value: no
    initial_value: '1'

  # Schedule state
  - id: sched_enabled
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: sched_days
    type: uint8_t
    restore_value: no
    initial_value: '0'
  - id: sched_time_1
    type: std::string
    restore_value: no
    initial_value: '"--:--"'
  - id: sched_time_2
    type: std::string
    restore_value: no
    initial_value: '"--:--"'
  - id: sched_time_3
    type: std::string
    restore_value: no
    initial_value: '"--:--"'
  - id: sched_time_4
    type: std::string
    restore_value: no
    initial_value: '"--:--"'

  # Time editor
  - id: time_edit_slot
    type: int
    restore_value: no
    initial_value: '1'
  - id: time_edit_hour
    type: int
    restore_value: no
    initial_value: '6'
  - id: time_edit_minute
    type: int
    restore_value: no
    initial_value: '0'

  # 12-hour format flag
  - id: use_12hour
    type: bool
    restore_value: yes
    initial_value: 'true'

  # Active zone page tracking
  - id: zone_active_showing
    type: bool
    restore_value: no
    initial_value: 'false'

# ──────────────────────────────────────────────
# Sensors
# ──────────────────────────────────────────────

sensor:
  - platform: rotary_encoder
    id: dial_encoder
    resolution: 4
    pin_a:
      number: GPIO40
      mode:
        input: true
        pullup: true
    pin_b:
      number: GPIO41
      mode:
        input: true
        pullup: true

  - platform: wifi_signal
    name: "WiFi Signal"
    id: wifi_signal_sensor
    update_interval: 60s

  - platform: uptime
    name: "Uptime"
    id: uptime_sensor

binary_sensor:
  - platform: gpio
    id: dial_button
    pin:
      number: GPIO42
      mode:
        input: true
        pullup: true
      inverted: true

  - platform: template
    name: "WiFi Connected"
    id: wifi_connected_bin
    device_class: "connectivity"
    lambda: 'return id(wifi_connected);'

  - platform: template
    name: "Rain Sensor"
    id: rain_sensor_entity
    icon: "mdi:weather-rainy"
    device_class: "moisture"
    lambda: 'return false;'

# ──────────────────────────────────────────────
# Text Sensors (read-only)
# ──────────────────────────────────────────────

text_sensor:
  - platform: version
    name: "ESPHome Version"

  - platform: wifi_info
    ip_address:
      name: "IP Address"
    ssid:
      name: "Connected SSID"

# ──────────────────────────────────────────────
# Template Text Entities (writable from HA)
# ──────────────────────────────────────────────

text:
  - platform: template
    name: "Valve Status"
    id: valve_status_entity
    icon: "mdi:valve"
    optimistic: true
    min_length: 0
    max_length: 64
    mode: text
    initial_value: "Idle"
    on_value:
      then:
        - lambda: |-
            lv_label_set_text(id(lbl_valve_status), x.c_str());
            // Color based on status
            if (x.find("Active") != std::string::npos) {
              lv_obj_set_style_text_color(id(lbl_valve_status), lv_color_hex(0x2979FF), 0);
              // Extract zone number for active zone display
              std::string zone_num = "--";
              for (size_t i = 0; i < x.find("Active"); i++) {
                if (isdigit(x[i])) {
                  size_t start = i;
                  while (i < x.size() && isdigit(x[i])) i++;
                  zone_num = x.substr(start, i - start);
                  break;
                }
              }
              lv_label_set_text(id(lbl_big_zone), zone_num.c_str());
            } else if (x == "Idle" || x == "System Ready") {
              lv_obj_set_style_text_color(id(lbl_valve_status), lv_color_hex(0x00E676), 0);
              if (id(zone_active_showing)) {
                id(zone_active_showing) = false;
                lv_scr_load(id(page_status)->obj);
              }
            } else if (x.find("Rain") != std::string::npos) {
              lv_obj_set_style_text_color(id(lbl_valve_status), lv_color_hex(0x2979FF), 0);
            } else if (x == "Paused") {
              lv_obj_set_style_text_color(id(lbl_valve_status), lv_color_hex(0xFFAB00), 0);
            } else {
              lv_obj_set_style_text_color(id(lbl_valve_status), lv_color_hex(0xFFFFFF), 0);
            }

  - platform: template
    name: "Time Remaining"
    id: time_remaining_entity
    icon: "mdi:timer-sand"
    optimistic: true
    min_length: 0
    max_length: 16
    mode: text
    initial_value: "--"
    on_value:
      then:
        - lambda: |-
            char buf[24];
            snprintf(buf, sizeof(buf), "Time: %s", x.c_str());
            lv_label_set_text(id(lbl_time_remaining), buf);
            lv_label_set_text(id(lbl_big_remaining), x.c_str());

  - platform: template
    name: "Progress"
    id: progress_entity
    icon: "mdi:progress-clock"
    optimistic: true
    min_length: 0
    max_length: 8
    mode: text
    initial_value: "0"
    on_value:
      then:
        - lambda: |-
            lv_label_set_text(id(lbl_progress), x.c_str());
            int pct = atoi(x.c_str());
            lv_bar_set_value(id(bar_progress), pct, LV_ANIM_ON);

  - platform: template
    name: "Active Zone"
    id: active_zone_entity
    icon: "mdi:sprinkler-variant"
    optimistic: true
    min_length: 0
    max_length: 8
    mode: text
    initial_value: "--"
    on_value:
      then:
        - lambda: |-
            lv_label_set_text(id(lbl_big_zone), x.c_str());

  - platform: template
    name: "Schedule Start Time 1"
    id: sched_time_1_entity
    icon: "mdi:clock-start"
    optimistic: true
    min_length: 0
    max_length: 8
    mode: text
    initial_value: ""
    on_value:
      then:
        - lambda: |-
            id(sched_time_1) = x.empty() ? "--:--" : x;
        - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Start Time 2"
    id: sched_time_2_entity
    icon: "mdi:clock-start"
    optimistic: true
    min_length: 0
    max_length: 8
    mode: text
    initial_value: ""
    on_value:
      then:
        - lambda: |-
            id(sched_time_2) = x.empty() ? "--:--" : x;
        - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Start Time 3"
    id: sched_time_3_entity
    icon: "mdi:clock-start"
    optimistic: true
    min_length: 0
    max_length: 8
    mode: text
    initial_value: ""
    on_value:
      then:
        - lambda: |-
            id(sched_time_3) = x.empty() ? "--:--" : x;
        - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Start Time 4"
    id: sched_time_4_entity
    icon: "mdi:clock-start"
    optimistic: true
    min_length: 0
    max_length: 8
    mode: text
    initial_value: ""
    on_value:
      then:
        - lambda: |-
            id(sched_time_4) = x.empty() ? "--:--" : x;
        - script.execute: refresh_schedule_page

# ──────────────────────────────────────────────
# Template Numbers
# ──────────────────────────────────────────────

number:
  - platform: template
    name: "Zone Count"
    id: zone_count_entity
    icon: "mdi:water"
    min_value: 1
    max_value: 32
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 8
    entity_category: config
    set_action:
      - lambda: |-
          id(zone_count) = (int)x;
          lv_slider_set_value(id(slider_zone_count), (int)x, LV_ANIM_ON);
          char buf[4];
          snprintf(buf, sizeof(buf), "%d", (int)x);
          lv_label_set_text(id(lbl_zone_count_val), buf);

  # Zone durations (1-32)
  - platform: template
    name: "Zone 1 Duration"
    id: zone_1_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 2 Duration"
    id: zone_2_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 3 Duration"
    id: zone_3_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 4 Duration"
    id: zone_4_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 5 Duration"
    id: zone_5_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 6 Duration"
    id: zone_6_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 7 Duration"
    id: zone_7_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 8 Duration"
    id: zone_8_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 9 Duration"
    id: zone_9_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 10 Duration"
    id: zone_10_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 11 Duration"
    id: zone_11_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 12 Duration"
    id: zone_12_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 13 Duration"
    id: zone_13_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 14 Duration"
    id: zone_14_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 15 Duration"
    id: zone_15_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 16 Duration"
    id: zone_16_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 17 Duration"
    id: zone_17_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 18 Duration"
    id: zone_18_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 19 Duration"
    id: zone_19_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 20 Duration"
    id: zone_20_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 21 Duration"
    id: zone_21_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 22 Duration"
    id: zone_22_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 23 Duration"
    id: zone_23_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 24 Duration"
    id: zone_24_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 25 Duration"
    id: zone_25_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 26 Duration"
    id: zone_26_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 27 Duration"
    id: zone_27_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 28 Duration"
    id: zone_28_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 29 Duration"
    id: zone_29_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 30 Duration"
    id: zone_30_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 31 Duration"
    id: zone_31_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2
  - platform: template
    name: "Zone 32 Duration"
    id: zone_32_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 2

# ──────────────────────────────────────────────
# Template Switches
# ──────────────────────────────────────────────

switch:
  - platform: template
    name: "Start Stop"
    id: main_switch_entity
    icon: "mdi:play-pause"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: |-
          lv_label_set_text(id(lbl_start_stop), "STOP");
          lv_obj_set_style_bg_color(id(btn_start_stop), lv_color_hex(0xFF3D00), 0);
    on_turn_off:
      - lambda: |-
          lv_label_set_text(id(lbl_start_stop), "START");
          lv_obj_set_style_bg_color(id(btn_start_stop), lv_color_hex(0x00E676), 0);

  - platform: template
    name: "Auto Advance"
    id: auto_advance_entity
    icon: "mdi:skip-next"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lvgl.label.update:
          id: lbl_auto_adv
          text: "AUTO: ON"
    on_turn_off:
      - lvgl.label.update:
          id: lbl_auto_adv
          text: "AUTO: OFF"

  - platform: template
    name: "Schedule Enabled"
    id: schedule_enabled_entity
    icon: "mdi:calendar-check"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(sched_enabled) = true;'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_enabled) = false;'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Monday"
    id: day_mon_entity
    icon: "mdi:calendar"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(sched_days) |= (1 << 0);'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_days) &= ~(1 << 0);'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Tuesday"
    id: day_tue_entity
    icon: "mdi:calendar"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(sched_days) |= (1 << 1);'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_days) &= ~(1 << 1);'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Wednesday"
    id: day_wed_entity
    icon: "mdi:calendar"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(sched_days) |= (1 << 2);'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_days) &= ~(1 << 2);'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Thursday"
    id: day_thu_entity
    icon: "mdi:calendar"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(sched_days) |= (1 << 3);'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_days) &= ~(1 << 3);'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Friday"
    id: day_fri_entity
    icon: "mdi:calendar"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(sched_days) |= (1 << 4);'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_days) &= ~(1 << 4);'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Saturday"
    id: day_sat_entity
    icon: "mdi:calendar"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(sched_days) |= (1 << 5);'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_days) &= ~(1 << 5);'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Sunday"
    id: day_sun_entity
    icon: "mdi:calendar"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(sched_days) |= (1 << 6);'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_days) &= ~(1 << 6);'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Use 12 Hour Format"
    id: use_12hour_entity
    icon: "mdi:clock-time-four"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    on_turn_on:
      - lambda: 'id(use_12hour) = true;'
    on_turn_off:
      - lambda: 'id(use_12hour) = false;'

  # Zone switches (1-32)
  - platform: template
    name: "Zone 1"
    id: zone_1_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 0);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 0);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 2"
    id: zone_2_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 1);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 1);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 3"
    id: zone_3_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 2);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 2);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 4"
    id: zone_4_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 3);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 3);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 5"
    id: zone_5_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 4);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 4);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 6"
    id: zone_6_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 5);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 5);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 7"
    id: zone_7_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 6);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 6);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 8"
    id: zone_8_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 7);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 7);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 9"
    id: zone_9_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 8);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 8);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 10"
    id: zone_10_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 9);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 9);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 11"
    id: zone_11_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 10);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 10);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 12"
    id: zone_12_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 11);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 11);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 13"
    id: zone_13_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 12);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 12);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 14"
    id: zone_14_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 13);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 13);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 15"
    id: zone_15_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 14);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 14);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 16"
    id: zone_16_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 15);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 15);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 17"
    id: zone_17_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 16);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 16);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 18"
    id: zone_18_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 17);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 17);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 19"
    id: zone_19_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 18);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 18);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 20"
    id: zone_20_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 19);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 19);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 21"
    id: zone_21_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 20);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 20);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 22"
    id: zone_22_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 21);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 21);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 23"
    id: zone_23_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 22);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 22);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 24"
    id: zone_24_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 23);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 23);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 25"
    id: zone_25_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 24);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 24);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 26"
    id: zone_26_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 25);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 25);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 27"
    id: zone_27_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 26);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 26);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 28"
    id: zone_28_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 27);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 27);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 29"
    id: zone_29_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 28);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 28);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 30"
    id: zone_30_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 29);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 29);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 31"
    id: zone_31_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 30);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 30);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 32"
    id: zone_32_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 31);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 31);'
      - script.execute: refresh_zone_buttons

# ──────────────────────────────────────────────
# Buttons (one-shot actions)
# ──────────────────────────────────────────────

button:
  - platform: template
    name: "Pause"
    id: pause_entity
    icon: "mdi:pause"

  - platform: template
    name: "Auto Detect Zones"
    id: auto_detect_entity
    icon: "mdi:magnify"
    entity_category: config

  - platform: restart
    name: "Restart"

# ──────────────────────────────────────────────
# Scripts
# ──────────────────────────────────────────────

script:
  # Helper: toggle a zone switch by number (1-32)
  - id: toggle_zone
    parameters:
      zone_num: int
    then:
      - lambda: |-
          esphome::template_::TemplateSwitch* sw[] = {
            id(zone_1_switch), id(zone_2_switch), id(zone_3_switch), id(zone_4_switch),
            id(zone_5_switch), id(zone_6_switch), id(zone_7_switch), id(zone_8_switch),
            id(zone_9_switch), id(zone_10_switch), id(zone_11_switch), id(zone_12_switch),
            id(zone_13_switch), id(zone_14_switch), id(zone_15_switch), id(zone_16_switch),
            id(zone_17_switch), id(zone_18_switch), id(zone_19_switch), id(zone_20_switch),
            id(zone_21_switch), id(zone_22_switch), id(zone_23_switch), id(zone_24_switch),
            id(zone_25_switch), id(zone_26_switch), id(zone_27_switch), id(zone_28_switch),
            id(zone_29_switch), id(zone_30_switch), id(zone_31_switch), id(zone_32_switch)
          };
          if (zone_num >= 1 && zone_num <= 32) sw[zone_num - 1]->toggle();

  # Helper: turn on a zone switch by number (1-32)
  - id: turn_on_zone
    parameters:
      zone_num: int
    then:
      - lambda: |-
          esphome::template_::TemplateSwitch* sw[] = {
            id(zone_1_switch), id(zone_2_switch), id(zone_3_switch), id(zone_4_switch),
            id(zone_5_switch), id(zone_6_switch), id(zone_7_switch), id(zone_8_switch),
            id(zone_9_switch), id(zone_10_switch), id(zone_11_switch), id(zone_12_switch),
            id(zone_13_switch), id(zone_14_switch), id(zone_15_switch), id(zone_16_switch),
            id(zone_17_switch), id(zone_18_switch), id(zone_19_switch), id(zone_20_switch),
            id(zone_21_switch), id(zone_22_switch), id(zone_23_switch), id(zone_24_switch),
            id(zone_25_switch), id(zone_26_switch), id(zone_27_switch), id(zone_28_switch),
            id(zone_29_switch), id(zone_30_switch), id(zone_31_switch), id(zone_32_switch)
          };
          if (zone_num >= 1 && zone_num <= 32) sw[zone_num - 1]->turn_on();

  # Helper: set zone duration by zone number
  - id: set_zone_duration
    parameters:
      zone_num: int
      duration_val: int
    then:
      - lambda: |-
          esphome::template_::TemplateNumber* nums[] = {
            id(zone_1_dur_entity), id(zone_2_dur_entity), id(zone_3_dur_entity), id(zone_4_dur_entity),
            id(zone_5_dur_entity), id(zone_6_dur_entity), id(zone_7_dur_entity), id(zone_8_dur_entity),
            id(zone_9_dur_entity), id(zone_10_dur_entity), id(zone_11_dur_entity), id(zone_12_dur_entity),
            id(zone_13_dur_entity), id(zone_14_dur_entity), id(zone_15_dur_entity), id(zone_16_dur_entity),
            id(zone_17_dur_entity), id(zone_18_dur_entity), id(zone_19_dur_entity), id(zone_20_dur_entity),
            id(zone_21_dur_entity), id(zone_22_dur_entity), id(zone_23_dur_entity), id(zone_24_dur_entity),
            id(zone_25_dur_entity), id(zone_26_dur_entity), id(zone_27_dur_entity), id(zone_28_dur_entity),
            id(zone_29_dur_entity), id(zone_30_dur_entity), id(zone_31_dur_entity), id(zone_32_dur_entity)
          };
          if (zone_num >= 1 && zone_num <= 32) {
            auto call = nums[zone_num - 1]->make_call();
            call.set_value(duration_val);
            call.perform();
          }

  # Helper: get zone duration by zone number (returns value to slider)
  - id: load_zone_duration
    parameters:
      zone_num: int
    then:
      - lambda: |-
          esphome::template_::TemplateNumber* nums[] = {
            id(zone_1_dur_entity), id(zone_2_dur_entity), id(zone_3_dur_entity), id(zone_4_dur_entity),
            id(zone_5_dur_entity), id(zone_6_dur_entity), id(zone_7_dur_entity), id(zone_8_dur_entity),
            id(zone_9_dur_entity), id(zone_10_dur_entity), id(zone_11_dur_entity), id(zone_12_dur_entity),
            id(zone_13_dur_entity), id(zone_14_dur_entity), id(zone_15_dur_entity), id(zone_16_dur_entity),
            id(zone_17_dur_entity), id(zone_18_dur_entity), id(zone_19_dur_entity), id(zone_20_dur_entity),
            id(zone_21_dur_entity), id(zone_22_dur_entity), id(zone_23_dur_entity), id(zone_24_dur_entity),
            id(zone_25_dur_entity), id(zone_26_dur_entity), id(zone_27_dur_entity), id(zone_28_dur_entity),
            id(zone_29_dur_entity), id(zone_30_dur_entity), id(zone_31_dur_entity), id(zone_32_dur_entity)
          };
          if (zone_num >= 1 && zone_num <= 32) {
            float val = nums[zone_num - 1]->state;
            if (std::isnan(val)) val = 2;
            lv_slider_set_value(id(slider_duration), (int)val, LV_ANIM_OFF);
            char buf[16];
            snprintf(buf, sizeof(buf), "%d min", (int)val);
            lv_label_set_text(id(lbl_dur_value), buf);
          }

  # Helper: refresh zone page buttons
  - id: refresh_zone_buttons
    then:
      - lambda: |-
          int offset = id(zone_page_offset);
          int zc = id(zone_count);
          lv_obj_t *btns[] = {id(btn_zone_1), id(btn_zone_2), id(btn_zone_3), id(btn_zone_4)};
          lv_obj_t *lbls[] = {id(lbl_zone_1), id(lbl_zone_2), id(lbl_zone_3), id(lbl_zone_4)};
          for (int i = 0; i < 4; i++) {
            int zone_num = offset + i + 1;
            if (zone_num <= zc) {
              lv_obj_clear_flag(btns[i], LV_OBJ_FLAG_HIDDEN);
              char buf[12];
              snprintf(buf, sizeof(buf), "Zone %d", zone_num);
              lv_label_set_text(lbls[i], buf);
              bool active = (id(zone_states) >> (zone_num - 1)) & 1;
              if (active) {
                lv_obj_set_style_bg_color(btns[i], lv_color_hex(0x2979FF), 0);
                lv_obj_set_style_text_color(lbls[i], lv_color_hex(0xFFFFFF), 0);
              } else {
                lv_obj_set_style_bg_color(btns[i], lv_color_hex(0x1A1A1A), 0);
                lv_obj_set_style_border_color(btns[i], lv_color_hex(0x00E676), 0);
                lv_obj_set_style_text_color(lbls[i], lv_color_hex(0x00E676), 0);
              }
            } else {
              lv_obj_add_flag(btns[i], LV_OBJ_FLAG_HIDDEN);
            }
          }
          char title[16];
          int last = offset + 4;
          if (last > zc) last = zc;
          snprintf(title, sizeof(title), "ZONES %d-%d", offset + 1, last);
          lv_label_set_text(id(lbl_zone_page_title), title);

  # Helper: refresh schedule page
  - id: refresh_schedule_page
    then:
      - lambda: |-
          // Update enabled label
          if (id(sched_enabled)) {
            lv_label_set_text(id(lbl_sched_enabled), "ON");
            lv_obj_set_style_text_color(id(lbl_sched_enabled), lv_color_hex(0x00E676), 0);
          } else {
            lv_label_set_text(id(lbl_sched_enabled), "OFF");
            lv_obj_set_style_text_color(id(lbl_sched_enabled), lv_color_hex(0xFF3D00), 0);
          }
          // Update day buttons
          lv_obj_t* day_btns[] = {id(btn_day_mon), id(btn_day_tue), id(btn_day_wed),
                                   id(btn_day_thu), id(btn_day_fri), id(btn_day_sat), id(btn_day_sun)};
          for (int i = 0; i < 7; i++) {
            bool on = (id(sched_days) >> i) & 1;
            if (on) {
              lv_obj_set_style_bg_color(day_btns[i], lv_color_hex(0x00E676), 0);
            } else {
              lv_obj_set_style_bg_color(day_btns[i], lv_color_hex(0x333333), 0);
            }
          }
          // Update time labels
          char buf[32];
          snprintf(buf, sizeof(buf), "1: %s", id(sched_time_1).c_str());
          lv_label_set_text(id(lbl_sched_t1), buf);
          snprintf(buf, sizeof(buf), "2: %s", id(sched_time_2).c_str());
          lv_label_set_text(id(lbl_sched_t2), buf);
          snprintf(buf, sizeof(buf), "3: %s", id(sched_time_3).c_str());
          lv_label_set_text(id(lbl_sched_t3), buf);
          snprintf(buf, sizeof(buf), "4: %s", id(sched_time_4).c_str());
          lv_label_set_text(id(lbl_sched_t4), buf);

  # Helper: update time editor display
  - id: update_time_display
    then:
      - lambda: |-
          int h = id(time_edit_hour);
          int m = id(time_edit_minute);
          char buf[16];
          if (id(use_12hour)) {
            int h12 = h % 12;
            if (h12 == 0) h12 = 12;
            const char* ampm = (h < 12) ? "AM" : "PM";
            snprintf(buf, sizeof(buf), "%d:%02d %s", h12, m, ampm);
            // Show AM/PM button
            lv_obj_clear_flag(id(btn_ampm), LV_OBJ_FLAG_HIDDEN);
            lv_label_set_text(id(lbl_ampm), ampm);
          } else {
            snprintf(buf, sizeof(buf), "%02d:%02d", h, m);
            // Hide AM/PM button
            lv_obj_add_flag(id(btn_ampm), LV_OBJ_FLAG_HIDDEN);
          }
          lv_label_set_text(id(lbl_time_display), buf);

# ──────────────────────────────────────────────
# Intervals
# ──────────────────────────────────────────────

interval:
  # Idle timeout: return to active zone page after 60s of no interaction
  - interval: 5s
    then:
      - lambda: |-
          std::string az = id(active_zone_entity).state;
          if (az != "--" && !az.empty() && !id(zone_active_showing)) {
            uint32_t idle_ms = lv_disp_get_inactive_time(NULL);
            if (idle_ms >= 60000) {
              id(zone_active_showing) = true;
              lv_scr_load(id(page_active_zone)->obj);
            }
          }
          if (id(zone_active_showing)) {
            uint32_t idle_ms = lv_disp_get_inactive_time(NULL);
            if (idle_ms < 1000) {
              id(zone_active_showing) = false;
              lv_scr_load(id(page_status)->obj);
            }
          }

# ──────────────────────────────────────────────
# LVGL UI
# ──────────────────────────────────────────────

lvgl:
  displays:
    - dial_lcd
  touchscreens:
    - touchscreen_id: touch
  encoders:
    - sensor: dial_encoder
      enter_button: dial_button
  color_depth: 16
  buffer_size: 10%
  default_font: montserrat_14
  disp_bg_color: 0x0D0D0D

  theme:
    button:
      focused:
        border_color: 0xFFFFFF
        border_width: 2
    slider:
      focused:
        border_color: 0xFFFFFF
        border_width: 2
      knob:
        edited:
          bg_color: 0xFF3D00

  style_definitions:
    - id: style_btn
      bg_color: 0x00E676
      radius: 8
      text_color: 0x0D0D0D
      pad_all: 6
    - id: style_btn_outline
      bg_color: 0x1A1A1A
      radius: 8
      border_width: 2
      border_color: 0x00E676
      text_color: 0x00E676
      pad_all: 6
    - id: style_btn_red
      bg_color: 0xFF3D00
      radius: 8
      text_color: 0xFFFFFF
      pad_all: 6

  pages:
    # ──────── PAGE: SPLASH ────────
    - id: page_splash
      bg_color: 0x0D0D0D
      bg_opa: COVER
      widgets:
        - label:
            text: "IRRIGATION"
            text_font: montserrat_28
            text_color: 0x00E676
            align: CENTER
            y: -20
        - label:
            text: "REMOTE"
            text_font: montserrat_14
            text_color: 0x888888
            align: CENTER
            y: 10
        - label:
            id: lbl_splash_status
            text: "Connecting..."
            text_font: montserrat_12
            text_color: 0x555555
            align: CENTER
            y: 35

    # ──────── PAGE: STATUS (Main Dashboard) ────────
    - id: page_status
      bg_color: 0x0D0D0D
      bg_opa: COVER
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_status));
      widgets:
        - label:
            text: "IRRIGATION"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 18

        - label:
            id: lbl_connection
            text: "HA Disconnected"
            text_font: montserrat_10
            text_color: 0xFF1744
            align: TOP_MID
            y: 34

        - label:
            id: lbl_valve_status
            text: "Idle"
            text_font: montserrat_14
            text_color: 0x00E676
            align: TOP_MID
            y: 52

        - label:
            id: lbl_time_remaining
            text: "Time: --"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 40
            y: 74

        - label:
            id: lbl_progress
            text: "0%"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            align: TOP_RIGHT
            x: -40
            y: 74

        - bar:
            id: bar_progress
            align: TOP_MID
            y: 92
            width: 160
            height: 8
            min_value: 0
            max_value: 100
            value: 0
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x00E676

        # Row 1: START/STOP + PAUSE
        - button:
            id: btn_start_stop
            x: 30
            y: 108
            width: 88
            height: 28
            styles: style_btn
            widgets:
              - label:
                  id: lbl_start_stop
                  text: "START"
                  text_font: montserrat_12
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - switch.toggle: main_switch_entity

        - button:
            id: btn_pause
            x: 124
            y: 108
            width: 88
            height: 28
            styles: style_btn_outline
            widgets:
              - label:
                  text: "PAUSE"
                  text_font: montserrat_12
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - button.press: pause_entity

        # Row 2: AUTO ADV + ZONES
        - button:
            id: btn_auto_adv
            x: 30
            y: 142
            width: 88
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  id: lbl_auto_adv
                  text: "AUTO: OFF"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - switch.toggle: auto_advance_entity

        - button:
            id: btn_goto_zones
            x: 124
            y: 142
            width: 88
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "ZONES >"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_zones
                    animation: NONE

        # Row 3: SCHEDULE + SETTINGS
        - button:
            id: btn_goto_schedule
            x: 30
            y: 174
            width: 88
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "SCHED >"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_schedule
                    animation: NONE

        - button:
            id: btn_goto_settings
            x: 124
            y: 174
            width: 88
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "SETUP >"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_settings
                    animation: NONE

        - label:
            id: lbl_wifi
            text: "WiFi: --"
            text_font: montserrat_10
            text_color: 0x444444
            align: BOTTOM_MID
            y: -6

    # ──────── PAGE: ZONES ────────
    - id: page_zones
      bg_color: 0x0D0D0D
      bg_opa: COVER
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_zones));
          - script.execute: refresh_zone_buttons
      widgets:
        - label:
            id: lbl_zone_page_title
            text: "ZONES 1-4"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 18

        # 2x2 grid of zone buttons
        - button:
            id: btn_zone_1
            x: 24
            y: 38
            width: 92
            height: 34
            styles: style_btn_outline
            widgets:
              - label:
                  id: lbl_zone_1
                  text: "Zone 1"
                  text_font: montserrat_12
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: 'id(last_selected_zone) = id(zone_page_offset) + 1;'
                - script.execute:
                    id: toggle_zone
                    zone_num: !lambda 'return id(zone_page_offset) + 1;'

        - button:
            id: btn_zone_2
            x: 124
            y: 38
            width: 92
            height: 34
            styles: style_btn_outline
            widgets:
              - label:
                  id: lbl_zone_2
                  text: "Zone 2"
                  text_font: montserrat_12
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: 'id(last_selected_zone) = id(zone_page_offset) + 2;'
                - script.execute:
                    id: toggle_zone
                    zone_num: !lambda 'return id(zone_page_offset) + 2;'

        - button:
            id: btn_zone_3
            x: 24
            y: 80
            width: 92
            height: 34
            styles: style_btn_outline
            widgets:
              - label:
                  id: lbl_zone_3
                  text: "Zone 3"
                  text_font: montserrat_12
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: 'id(last_selected_zone) = id(zone_page_offset) + 3;'
                - script.execute:
                    id: toggle_zone
                    zone_num: !lambda 'return id(zone_page_offset) + 3;'

        - button:
            id: btn_zone_4
            x: 124
            y: 80
            width: 92
            height: 34
            styles: style_btn_outline
            widgets:
              - label:
                  id: lbl_zone_4
                  text: "Zone 4"
                  text_font: montserrat_12
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: 'id(last_selected_zone) = id(zone_page_offset) + 4;'
                - script.execute:
                    id: toggle_zone
                    zone_num: !lambda 'return id(zone_page_offset) + 4;'

        # Nav: PREV / NEXT
        - button:
            id: btn_zone_prev
            x: 30
            y: 122
            width: 80
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "< PREV"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    if (id(zone_page_offset) >= 4)
                      id(zone_page_offset) -= 4;
                - script.execute: refresh_zone_buttons

        - button:
            id: btn_zone_next
            x: 130
            y: 122
            width: 80
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "NEXT >"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    if (id(zone_page_offset) + 4 < id(zone_count))
                      id(zone_page_offset) += 4;
                - script.execute: refresh_zone_buttons

        # Bottom row: BACK / RUN NOW / TIMER
        - button:
            id: btn_zones_back
            x: 18
            y: 154
            width: 60
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "BACK"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_status
                    animation: NONE

        - button:
            id: btn_zone_run
            x: 86
            y: 154
            width: 68
            height: 24
            styles: style_btn
            widgets:
              - label:
                  text: "RUN"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - script.execute:
                    id: turn_on_zone
                    zone_num: !lambda 'return id(last_selected_zone);'

        - button:
            id: btn_goto_dur
            x: 162
            y: 154
            width: 60
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "TIMER"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_duration
                    animation: NONE

    # ──────── PAGE: DURATION ────────
    - id: page_duration
      bg_color: 0x0D0D0D
      bg_opa: COVER
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_duration));
              char buf[16];
              snprintf(buf, sizeof(buf), "Zone %d", id(dur_selected_zone));
              lv_label_set_text(id(lbl_dur_zone_name), buf);
          - script.execute:
              id: load_zone_duration
              zone_num: !lambda 'return id(dur_selected_zone);'
      widgets:
        - label:
            text: "ZONE DURATION"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 22

        - button:
            id: btn_dur_zone_prev
            x: 30
            y: 44
            width: 40
            height: 28
            styles: style_btn_outline
            widgets:
              - label:
                  text: "<"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    if (id(dur_selected_zone) > 1) {
                      id(dur_selected_zone)--;
                      char buf[16];
                      snprintf(buf, sizeof(buf), "Zone %d", id(dur_selected_zone));
                      lv_label_set_text(id(lbl_dur_zone_name), buf);
                    }
                - script.execute:
                    id: load_zone_duration
                    zone_num: !lambda 'return id(dur_selected_zone);'

        - label:
            id: lbl_dur_zone_name
            text: "Zone 1"
            text_font: montserrat_14
            text_color: 0x00E676
            align: TOP_MID
            y: 48

        - button:
            id: btn_dur_zone_next
            x: 170
            y: 44
            width: 40
            height: 28
            styles: style_btn_outline
            widgets:
              - label:
                  text: ">"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    if (id(dur_selected_zone) < id(zone_count)) {
                      id(dur_selected_zone)++;
                      char buf[16];
                      snprintf(buf, sizeof(buf), "Zone %d", id(dur_selected_zone));
                      lv_label_set_text(id(lbl_dur_zone_name), buf);
                    }
                - script.execute:
                    id: load_zone_duration
                    zone_num: !lambda 'return id(dur_selected_zone);'

        - label:
            id: lbl_dur_value
            text: "2 min"
            text_font: montserrat_28
            text_color: 0xFFFFFF
            align: CENTER
            y: -16

        - slider:
            id: slider_duration
            align: CENTER
            y: 20
            width: 160
            height: 14
            min_value: 1
            max_value: 60
            value: 2
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x00E676
            knob:
              bg_color: 0xFFFFFF
              radius: 7
              width: 14
              height: 14
            on_value:
              then:
                - lvgl.label.update:
                    id: lbl_dur_value
                    text:
                      format: "%d min"
                      args: ['(int)x']

        - button:
            id: btn_dur_set
            align: CENTER
            y: 54
            width: 120
            height: 30
            styles: style_btn
            widgets:
              - label:
                  text: "SET"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - script.execute:
                    id: set_zone_duration
                    zone_num: !lambda 'return id(dur_selected_zone);'
                    duration_val: !lambda 'return lv_slider_get_value(id(slider_duration));'

        - button:
            id: btn_dur_back
            align: BOTTOM_MID
            y: -28
            width: 80
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "< BACK"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_zones
                    animation: NONE

    # ──────── PAGE: SCHEDULE ────────
    - id: page_schedule
      bg_color: 0x0D0D0D
      bg_opa: COVER
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_schedule));
          - script.execute: refresh_schedule_page
      widgets:
        - label:
            text: "SCHEDULE"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 18

        # Enable toggle
        - button:
            id: btn_sched_toggle
            x: 40
            y: 36
            width: 100
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "Enabled:"
                  text_font: montserrat_10
                  align: LEFT_MID
                  x: 4
                  text_color: 0x888888
              - label:
                  id: lbl_sched_enabled
                  text: "OFF"
                  text_font: montserrat_10
                  align: RIGHT_MID
                  x: -4
                  text_color: 0xFF3D00
            on_click:
              then:
                - switch.toggle: schedule_enabled_entity

        # Day of week buttons (7 in a row)
        - button:
            id: btn_day_mon
            x: 22
            y: 66
            width: 26
            height: 24
            radius: 4
            bg_color: 0x333333
            widgets:
              - label:
                  text: "M"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - switch.toggle: day_mon_entity

        - button:
            id: btn_day_tue
            x: 52
            y: 66
            width: 26
            height: 24
            radius: 4
            bg_color: 0x333333
            widgets:
              - label:
                  text: "T"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - switch.toggle: day_tue_entity

        - button:
            id: btn_day_wed
            x: 82
            y: 66
            width: 26
            height: 24
            radius: 4
            bg_color: 0x333333
            widgets:
              - label:
                  text: "W"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - switch.toggle: day_wed_entity

        - button:
            id: btn_day_thu
            x: 112
            y: 66
            width: 26
            height: 24
            radius: 4
            bg_color: 0x333333
            widgets:
              - label:
                  text: "T"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - switch.toggle: day_thu_entity

        - button:
            id: btn_day_fri
            x: 142
            y: 66
            width: 26
            height: 24
            radius: 4
            bg_color: 0x333333
            widgets:
              - label:
                  text: "F"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - switch.toggle: day_fri_entity

        - button:
            id: btn_day_sat
            x: 172
            y: 66
            width: 26
            height: 24
            radius: 4
            bg_color: 0x333333
            widgets:
              - label:
                  text: "S"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - switch.toggle: day_sat_entity

        - button:
            id: btn_day_sun
            x: 202
            y: 66
            width: 26
            height: 24
            radius: 4
            bg_color: 0x333333
            widgets:
              - label:
                  text: "S"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - switch.toggle: day_sun_entity

        # Start time displays (2x2)
        - label:
            id: lbl_sched_t1
            text: "1: --:--"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 30
            y: 98
        - label:
            id: lbl_sched_t2
            text: "2: --:--"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 130
            y: 98
        - label:
            id: lbl_sched_t3
            text: "3: --:--"
            text_font: montserrat_12
            text_color: 0x888888
            x: 30
            y: 118
        - label:
            id: lbl_sched_t4
            text: "4: --:--"
            text_font: montserrat_12
            text_color: 0x888888
            x: 130
            y: 118

        # Bottom row
        - button:
            id: btn_goto_time_edit
            x: 30
            y: 146
            width: 100
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "EDIT TIMES"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_time_edit
                    animation: NONE

        - button:
            id: btn_sched_back
            x: 140
            y: 146
            width: 80
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "< BACK"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_status
                    animation: NONE

    # ──────── PAGE: TIME EDITOR (Redesigned — encoder +/- buttons) ────────
    - id: page_time_edit
      bg_color: 0x0D0D0D
      bg_opa: COVER
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_time_edit));
              // Update title
              char buf[24];
              snprintf(buf, sizeof(buf), "START TIME %d", id(time_edit_slot));
              lv_label_set_text(id(lbl_time_edit_title), buf);
              // Parse current time from sched_time global
              std::string current;
              int slot = id(time_edit_slot);
              if (slot == 1) current = id(sched_time_1);
              else if (slot == 2) current = id(sched_time_2);
              else if (slot == 3) current = id(sched_time_3);
              else current = id(sched_time_4);
              // Parse HH:MM
              if (current.length() >= 5 && current[2] == ':') {
                id(time_edit_hour) = atoi(current.substr(0, 2).c_str());
                id(time_edit_minute) = atoi(current.substr(3, 2).c_str());
              } else {
                id(time_edit_hour) = 6;
                id(time_edit_minute) = 0;
              }
          - script.execute: update_time_display
      widgets:
        - label:
            id: lbl_time_edit_title
            text: "START TIME 1"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 18

        # Slot selector
        - button:
            id: btn_slot_prev
            x: 40
            y: 36
            width: 40
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "<"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    if (id(time_edit_slot) > 1) {
                      id(time_edit_slot)--;
                      char buf[24];
                      snprintf(buf, sizeof(buf), "START TIME %d", id(time_edit_slot));
                      lv_label_set_text(id(lbl_time_edit_title), buf);
                      // Load time for new slot
                      std::string current;
                      int slot = id(time_edit_slot);
                      if (slot == 1) current = id(sched_time_1);
                      else if (slot == 2) current = id(sched_time_2);
                      else if (slot == 3) current = id(sched_time_3);
                      else current = id(sched_time_4);
                      if (current.length() >= 5 && current[2] == ':') {
                        id(time_edit_hour) = atoi(current.substr(0, 2).c_str());
                        id(time_edit_minute) = atoi(current.substr(3, 2).c_str());
                      } else {
                        id(time_edit_hour) = 6;
                        id(time_edit_minute) = 0;
                      }
                    }
                - script.execute: update_time_display

        - button:
            id: btn_slot_next
            x: 160
            y: 36
            width: 40
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: ">"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    if (id(time_edit_slot) < 4) {
                      id(time_edit_slot)++;
                      char buf[24];
                      snprintf(buf, sizeof(buf), "START TIME %d", id(time_edit_slot));
                      lv_label_set_text(id(lbl_time_edit_title), buf);
                      std::string current;
                      int slot = id(time_edit_slot);
                      if (slot == 1) current = id(sched_time_1);
                      else if (slot == 2) current = id(sched_time_2);
                      else if (slot == 3) current = id(sched_time_3);
                      else current = id(sched_time_4);
                      if (current.length() >= 5 && current[2] == ':') {
                        id(time_edit_hour) = atoi(current.substr(0, 2).c_str());
                        id(time_edit_minute) = atoi(current.substr(3, 2).c_str());
                      } else {
                        id(time_edit_hour) = 6;
                        id(time_edit_minute) = 0;
                      }
                    }
                - script.execute: update_time_display

        # Time display
        - label:
            id: lbl_time_display
            text: "06:00"
            text_font: montserrat_28
            text_color: 0xFFFFFF
            align: CENTER
            y: -26

        # Hour +/- buttons
        - button:
            id: btn_hour_up
            x: 28
            y: 100
            width: 44
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "HR+"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    id(time_edit_hour) = (id(time_edit_hour) + 1) % 24;
                - script.execute: update_time_display

        - button:
            id: btn_hour_down
            x: 76
            y: 100
            width: 44
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "HR-"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    id(time_edit_hour) = (id(time_edit_hour) + 23) % 24;
                - script.execute: update_time_display

        # Minute +/- buttons
        - button:
            id: btn_min_up
            x: 124
            y: 100
            width: 44
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "MN+"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    id(time_edit_minute) = (id(time_edit_minute) + 1) % 60;
                - script.execute: update_time_display

        - button:
            id: btn_min_down
            x: 172
            y: 100
            width: 44
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "MN-"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    id(time_edit_minute) = (id(time_edit_minute) + 59) % 60;
                - script.execute: update_time_display

        # AM/PM toggle (visible only in 12hr mode)
        - button:
            id: btn_ampm
            align: TOP_MID
            y: 130
            width: 60
            height: 22
            styles: style_btn_outline
            widgets:
              - label:
                  id: lbl_ampm
                  text: "AM"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    // Toggle AM/PM by flipping 12 hours
                    if (id(time_edit_hour) < 12) {
                      id(time_edit_hour) += 12;
                    } else {
                      id(time_edit_hour) -= 12;
                    }
                - script.execute: update_time_display

        # Bottom buttons: SET / CLEAR / BACK
        - button:
            id: btn_time_set
            x: 18
            y: 158
            width: 64
            height: 26
            styles: style_btn
            widgets:
              - label:
                  text: "SET"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - lambda: |-
                    // Always store as 24hr "HH:MM" internally
                    char time_buf[8];
                    snprintf(time_buf, sizeof(time_buf), "%02d:%02d", id(time_edit_hour), id(time_edit_minute));
                    std::string ts = time_buf;
                    int slot = id(time_edit_slot);
                    if (slot == 1) { id(sched_time_1) = ts; auto call = id(sched_time_1_entity).make_call(); call.set_value(ts); call.perform(); }
                    else if (slot == 2) { id(sched_time_2) = ts; auto call = id(sched_time_2_entity).make_call(); call.set_value(ts); call.perform(); }
                    else if (slot == 3) { id(sched_time_3) = ts; auto call = id(sched_time_3_entity).make_call(); call.set_value(ts); call.perform(); }
                    else if (slot == 4) { id(sched_time_4) = ts; auto call = id(sched_time_4_entity).make_call(); call.set_value(ts); call.perform(); }

        - button:
            id: btn_time_clear
            x: 88
            y: 158
            width: 64
            height: 26
            styles: style_btn_red
            widgets:
              - label:
                  text: "CLEAR"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - lambda: |-
                    int slot = id(time_edit_slot);
                    std::string empty = "";
                    if (slot == 1) { id(sched_time_1) = "--:--"; auto call = id(sched_time_1_entity).make_call(); call.set_value(empty); call.perform(); }
                    else if (slot == 2) { id(sched_time_2) = "--:--"; auto call = id(sched_time_2_entity).make_call(); call.set_value(empty); call.perform(); }
                    else if (slot == 3) { id(sched_time_3) = "--:--"; auto call = id(sched_time_3_entity).make_call(); call.set_value(empty); call.perform(); }
                    else if (slot == 4) { id(sched_time_4) = "--:--"; auto call = id(sched_time_4_entity).make_call(); call.set_value(empty); call.perform(); }
                    id(time_edit_hour) = 6;
                    id(time_edit_minute) = 0;
                - script.execute: update_time_display

        - button:
            id: btn_time_back
            x: 158
            y: 158
            width: 64
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "BACK"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_schedule
                    animation: NONE

    # ──────── PAGE: SETTINGS (Simplified — no IP editor) ────────
    - id: page_settings
      bg_color: 0x0D0D0D
      bg_opa: COVER
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_settings));
              lv_slider_set_value(id(slider_zone_count), id(zone_count), LV_ANIM_OFF);
              char zc[4];
              snprintf(zc, sizeof(zc), "%d", id(zone_count));
              lv_label_set_text(id(lbl_zone_count_val), zc);
              // Update 12hr toggle label
              if (id(use_12hour)) {
                lv_label_set_text(id(lbl_12hr_toggle), "12 HR");
              } else {
                lv_label_set_text(id(lbl_12hr_toggle), "24 HR");
              }
      widgets:
        - label:
            text: "SETTINGS"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 22

        # Zone count
        - label:
            text: "Zones:"
            text_font: montserrat_10
            text_color: 0x888888
            x: 30
            y: 48

        - slider:
            id: slider_zone_count
            x: 74
            y: 50
            width: 100
            height: 12
            min_value: 1
            max_value: 32
            value: 8
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x00E676
            knob:
              bg_color: 0xFFFFFF
              radius: 6
            on_value:
              then:
                - lvgl.label.update:
                    id: lbl_zone_count_val
                    text:
                      format: "%d"
                      args: ['(int)x']

        - label:
            id: lbl_zone_count_val
            text: "8"
            text_font: montserrat_12
            text_color: 0x00E676
            x: 184
            y: 46

        # Auto detect button
        - button:
            id: btn_auto_detect
            align: TOP_MID
            y: 76
            width: 140
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "AUTO DETECT"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - button.press: auto_detect_entity

        # 12/24 Hour toggle
        - button:
            id: btn_12hr_toggle
            align: TOP_MID
            y: 110
            width: 140
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  id: lbl_12hr_toggle
                  text: "12 HR"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - switch.toggle: use_12hour_entity
                - lambda: |-
                    if (id(use_12hour)) {
                      lv_label_set_text(id(lbl_12hr_toggle), "12 HR");
                    } else {
                      lv_label_set_text(id(lbl_12hr_toggle), "24 HR");
                    }

        # Save button
        - button:
            id: btn_settings_save
            align: CENTER
            y: 36
            width: 120
            height: 30
            styles: style_btn
            widgets:
              - label:
                  text: "SAVE"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - lambda: |-
                    int zc = lv_slider_get_value(id(slider_zone_count));
                    id(zone_count) = zc;
                    auto call = id(zone_count_entity).make_call();
                    call.set_value(zc);
                    call.perform();

        # Back button
        - button:
            id: btn_settings_back
            align: BOTTOM_MID
            y: -28
            width: 80
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "< BACK"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_status
                    animation: NONE

    # ──────── PAGE: ACTIVE ZONE (big display when zone running) ────────
    - id: page_active_zone
      bg_color: 0x0D0D0D
      bg_opa: COVER
      widgets:
        - label:
            id: lbl_big_zone_title
            text: "ZONE"
            text_font: montserrat_14
            text_color: 0x888888
            align: TOP_MID
            y: 40

        - label:
            id: lbl_big_zone
            text: "--"
            text_font: montserrat_48
            text_color: 0x00E676
            align: CENTER
            y: -20

        - label:
            id: lbl_big_remaining
            text: "--"
            text_font: montserrat_28
            text_color: 0x2979FF
            align: CENTER
            y: 40

        - label:
            text: "tap to exit"
            text_font: montserrat_10
            text_color: 0x444444
            align: BOTTOM_MID
            y: -20
