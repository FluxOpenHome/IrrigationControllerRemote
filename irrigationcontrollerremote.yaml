# Irrigation Controller Remote - M5Stack Dial (StampS3)
# Remote control for the FluxOpenHome Irrigation Controller
# v2.14.0 — Fix active zone page not showing after boot sync
# All entities are optimistic templates. HA automations sync
# bidirectionally between this remote and the controller.

substitutions:
  name: "irrigation-remote"
  friendly_name: "Irrigation Remote"
  software_version: "2.14.0"

esphome:
  name: "${name}"
  friendly_name: "${friendly_name}"
  name_add_mac_suffix: true
  project:
    name: "FluxOpenHome.IrrigationRemote"
    version: "${software_version}"
  platformio_options:
    board_build.flash_mode: dio
    board_build.flash_size: 8MB
  on_boot:
    priority: -100
    then:
      - lambda: |-
          // Create per-page focus groups for encoder navigation
          lv_group_t *g_status   = lv_group_create();
          lv_group_t *g_zones    = lv_group_create();
          lv_group_t *g_dur      = lv_group_create();
          lv_group_t *g_sched    = lv_group_create();
          lv_group_t *g_time_ed  = lv_group_create();
          lv_group_t *g_settings = lv_group_create();
          lv_group_t *g_hour_sel = lv_group_create();
          lv_group_t *g_minute_sel = lv_group_create();
          lv_group_t *g_active_zone = lv_group_create();

          // page_status
          lv_group_add_obj(g_status, id(btn_goto_zones));
          lv_group_add_obj(g_status, id(btn_goto_schedule));
          lv_group_add_obj(g_status, id(btn_goto_settings));

          // page_zones
          lv_group_add_obj(g_zones, id(btn_zone_1));
          lv_group_add_obj(g_zones, id(btn_zone_2));
          lv_group_add_obj(g_zones, id(btn_zone_3));
          lv_group_add_obj(g_zones, id(btn_zone_4));
          lv_group_add_obj(g_zones, id(btn_zone_prev));
          lv_group_add_obj(g_zones, id(btn_zone_next));
          lv_group_add_obj(g_zones, id(btn_goto_dur));
          lv_group_add_obj(g_zones, id(btn_zones_back));

          // page_duration
          lv_group_add_obj(g_dur, id(btn_dur_zone_prev));
          lv_group_add_obj(g_dur, id(btn_dur_zone_next));
          lv_group_add_obj(g_dur, id(slider_duration));
          lv_group_add_obj(g_dur, id(btn_dur_set));
          lv_group_add_obj(g_dur, id(btn_dur_back));

          // page_schedule
          lv_group_add_obj(g_sched, id(btn_sched_toggle));
          lv_group_add_obj(g_sched, id(btn_day_mon));
          lv_group_add_obj(g_sched, id(btn_day_tue));
          lv_group_add_obj(g_sched, id(btn_day_wed));
          lv_group_add_obj(g_sched, id(btn_day_thu));
          lv_group_add_obj(g_sched, id(btn_day_fri));
          lv_group_add_obj(g_sched, id(btn_day_sat));
          lv_group_add_obj(g_sched, id(btn_day_sun));
          lv_group_add_obj(g_sched, id(btn_goto_time_edit));
          lv_group_add_obj(g_sched, id(btn_sched_back));

          // page_time_edit
          lv_group_add_obj(g_time_ed, id(btn_slot_prev));
          lv_group_add_obj(g_time_ed, id(btn_slot_next));
          lv_group_add_obj(g_time_ed, id(btn_hour_select));
          lv_group_add_obj(g_time_ed, id(btn_minute_select));
          lv_group_add_obj(g_time_ed, id(btn_ampm));
          lv_group_add_obj(g_time_ed, id(btn_time_set));
          lv_group_add_obj(g_time_ed, id(btn_time_clear));
          lv_group_add_obj(g_time_ed, id(btn_time_back));

          // page_settings
          lv_group_add_obj(g_settings, id(btn_12hr_toggle));
          lv_group_add_obj(g_settings, id(btn_settings_back));

          // page_hour_select
          lv_group_add_obj(g_hour_sel, id(btn_hour_confirm));

          // page_minute_select
          lv_group_add_obj(g_minute_sel, id(btn_minute_confirm));

          // page_active_zone
          lv_group_add_obj(g_active_zone, id(btn_active_stop));

          // Store group pointers
          id(grp_status)    = (void*)g_status;
          id(grp_zones)     = (void*)g_zones;
          id(grp_duration)  = (void*)g_dur;
          id(grp_schedule)  = (void*)g_sched;
          id(grp_time_edit) = (void*)g_time_ed;
          id(grp_settings)  = (void*)g_settings;
          id(grp_hour_sel)  = (void*)g_hour_sel;
          id(grp_minute_sel) = (void*)g_minute_sel;
          id(grp_active_zone) = (void*)g_active_zone;

          // Find encoder indev and assign initial group
          lv_indev_t *enc = nullptr;
          while ((enc = lv_indev_get_next(enc)) != nullptr) {
            if (lv_indev_get_type(enc) == LV_INDEV_TYPE_ENCODER) {
              id(enc_indev) = (void*)enc;
              lv_indev_set_group(enc, g_status);
              break;
            }
          }
      - light.turn_on:
          id: lcd_backlight
          brightness: 100%
      - lvgl.page.show:
          id: page_splash
          animation: NONE
      - wait_until:
          condition:
            lambda: 'return !id(sync_needed_entity).state;'
      - lambda: |-
          // After sync, show active zone page if zones are already running
          if (id(zone_states) != 0) {
            id(zone_active_showing) = true;
            lv_scr_load(id(page_active_zone)->obj);
          } else {
            id(zone_active_showing) = false;
            lv_scr_load(id(page_status)->obj);
          }

esp32:
  variant: esp32s3
  board: esp32-s3-devkitc-1
  flash_size: 8MB
  framework:
    type: esp-idf

logger:
  level: DEBUG

api:
  id: api_server
  on_client_connected:
    - lambda: 'id(wifi_connected) = true;'
  on_client_disconnected:
    - lambda: 'id(wifi_connected) = false;'

ota:
  - id: ota_component
    platform: esphome
  - id: ota_http_request
    platform: http_request

# HTTP request component for firmware updates
http_request:
  id: http_request_component
  buffer_size_rx: 8192
  buffer_size_tx: 4096
  follow_redirects: true
  timeout: 30s
  verify_ssl: true

# Firmware update from GitHub
update:
  - platform: http_request
    id: firmware_update
    name: "Firmware Update"
    source: https://raw.githubusercontent.com/FluxOpenHome/IrrigationControllerRemote/main/manifest.json

wifi:
  id: wifi_component
  ap:
    ssid: "${name}"
  on_connect:
    - lambda: 'id(wifi_connected) = true;'
    - lvgl.label.update:
        id: lbl_wifi
        text: "WiFi: ON"
    - lambda: |-
        lv_obj_set_style_text_color(id(lbl_wifi), lv_color_hex(0x00E676), 0);
  on_disconnect:
    - lambda: 'id(wifi_connected) = false;'
    - lvgl.label.update:
        id: lbl_wifi
        text: "WiFi: OFF"
    - lambda: |-
        lv_obj_set_style_text_color(id(lbl_wifi), lv_color_hex(0xFF1744), 0);

captive_portal:

esp32_improv:
  authorizer: none

improv_serial:

dashboard_import:
  package_import_url: github://FluxOpenHome/IrrigationControllerRemote/irrigationcontrollerremote.yaml@main
  import_full_config: true

web_server:
  port: 80

# ──────────────────────────────────────────────
# HA Time Component
# ──────────────────────────────────────────────

time:
  - platform: homeassistant
    id: ha_time

# ──────────────────────────────────────────────
# M5Stack Dial (StampS3) Hardware
# ──────────────────────────────────────────────

i2c:
  - id: internal_i2c
    sda: GPIO11
    scl: GPIO12

spi:
  - id: spi_bus
    clk_pin: GPIO6
    mosi_pin: GPIO5

output:
  - platform: ledc
    pin: GPIO9
    id: lcd_backlight_output
    channel: 0

display:
  - platform: ili9xxx
    model: GC9A01A
    cs_pin: GPIO7
    reset_pin: GPIO8
    dc_pin: GPIO4
    id: dial_lcd
    invert_colors: true
    auto_clear_enabled: false
    update_interval: never

touchscreen:
  - platform: ft5x06
    id: touch
    i2c_id: internal_i2c
    address: 0x38
    on_touch:
      then:
        - lambda: |-
            if (id(screen_sleeping)) {
              id(screen_sleeping) = false;
              id(lcd_backlight).turn_on().set_brightness(1.0f).perform();
            }

light:
  - platform: monochromatic
    id: lcd_backlight
    name: "LCD Backlight"
    icon: "mdi:television"
    entity_category: config
    output: lcd_backlight_output
    restore_mode: RESTORE_DEFAULT_ON
    default_transition_length: 0s

# ──────────────────────────────────────────────
# Images
# ──────────────────────────────────────────────

image:
  - file: "logo_white_120.png"
    id: img_logo
    resize: 130x42
    type: RGB565
    transparency: alpha_channel

# ──────────────────────────────────────────────
# Globals
# ──────────────────────────────────────────────

globals:
  # Encoder focus groups (per-page)
  - id: enc_indev
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_status
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_zones
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_duration
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_schedule
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_time_edit
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_settings
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_hour_sel
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_minute_sel
    type: void*
    restore_value: no
    initial_value: 'nullptr'
  - id: grp_active_zone
    type: void*
    restore_value: no
    initial_value: 'nullptr'

  # WiFi state
  - id: wifi_connected
    type: bool
    restore_value: no
    initial_value: 'false'

  # Zone count (configurable, persists)
  - id: zone_count
    type: int
    restore_value: no
    initial_value: '8'

  # Zone states bitmask (bit N = zone N+1 active)
  - id: zone_states
    type: uint32_t
    restore_value: no
    initial_value: '0'

  # Zone page navigation
  - id: zone_page_offset
    type: int
    restore_value: no
    initial_value: '0'
  - id: last_selected_zone
    type: int
    restore_value: no
    initial_value: '1'

  # Duration page
  - id: dur_selected_zone
    type: int
    restore_value: no
    initial_value: '1'

  # Schedule state
  - id: sched_enabled
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: sched_days
    type: uint8_t
    restore_value: no
    initial_value: '0'
  - id: sched_time_1
    type: std::string
    restore_value: no
    initial_value: '"--:--"'
  - id: sched_time_2
    type: std::string
    restore_value: no
    initial_value: '"--:--"'
  - id: sched_time_3
    type: std::string
    restore_value: no
    initial_value: '"--:--"'
  - id: sched_time_4
    type: std::string
    restore_value: no
    initial_value: '"--:--"'

  # Time editor
  - id: time_edit_slot
    type: int
    restore_value: no
    initial_value: '1'
  - id: time_edit_hour
    type: int
    restore_value: no
    initial_value: '6'
  - id: time_edit_minute
    type: int
    restore_value: no
    initial_value: '0'

  # Time edit mode (0=normal, 1=editing_hour, 2=editing_minute)
  - id: time_edit_mode
    type: int
    restore_value: no
    initial_value: '0'

  # Encoder last value for direction tracking
  - id: encoder_last_value
    type: int
    restore_value: no
    initial_value: '0'

  # 12-hour format flag
  - id: use_12hour
    type: bool
    restore_value: no
    initial_value: 'true'

  # Time edit returning flag (skip re-parse when coming back from hour/minute sub-pages)
  - id: time_edit_returning
    type: bool
    restore_value: no
    initial_value: 'false'

  # Active zone page tracking
  - id: zone_active_showing
    type: bool
    restore_value: no
    initial_value: 'false'

  # Screen sleep tracking
  - id: screen_sleeping
    type: bool
    restore_value: no
    initial_value: 'false'

  # Local countdown (seconds)
  - id: countdown_remaining
    type: int
    restore_value: no
    initial_value: '0'
  - id: countdown_total
    type: int
    restore_value: no
    initial_value: '0'
  - id: countdown_running
    type: bool
    restore_value: no
    initial_value: 'false'

# ──────────────────────────────────────────────
# Sensors
# ──────────────────────────────────────────────

sensor:
  - platform: rotary_encoder
    id: dial_encoder
    resolution: 4
    pin_a:
      number: GPIO40
      mode:
        input: true
        pullup: true
    pin_b:
      number: GPIO41
      mode:
        input: true
        pullup: true
    on_value:
      then:
        - lambda: |-
            int cur = (int)x;
            int last = id(encoder_last_value);
            int diff = cur - last;
            id(encoder_last_value) = cur;
            if (diff == 0) return;
            // Wake screen on dial turn
            if (id(screen_sleeping)) {
              id(screen_sleeping) = false;
              id(lcd_backlight).turn_on().set_brightness(1.0f).perform();
              return;  // swallow this input so it doesn't navigate
            }
            int mode = id(time_edit_mode);
            if (mode == 1) {
              // Editing hour
              if (diff > 0) {
                id(time_edit_hour) = (id(time_edit_hour) + 1) % 24;
              } else {
                id(time_edit_hour) = (id(time_edit_hour) + 23) % 24;
              }
              // Update hour display
              char buf[8];
              int h = id(time_edit_hour);
              if (id(use_12hour)) {
                int h12 = h % 12;
                if (h12 == 0) h12 = 12;
                snprintf(buf, sizeof(buf), "%d", h12);
              } else {
                snprintf(buf, sizeof(buf), "%02d", h);
              }
              lv_label_set_text(id(lbl_hour_value), buf);
            } else if (mode == 2) {
              // Editing minute
              if (diff > 0) {
                id(time_edit_minute) = (id(time_edit_minute) + 1) % 60;
              } else {
                id(time_edit_minute) = (id(time_edit_minute) + 59) % 60;
              }
              // Update minute display
              char buf[8];
              snprintf(buf, sizeof(buf), "%02d", id(time_edit_minute));
              lv_label_set_text(id(lbl_minute_value), buf);
            }

  - platform: wifi_signal
    name: "WiFi Signal"
    id: wifi_signal_sensor
    update_interval: 60s

  - platform: uptime
    name: "Uptime"
    id: uptime_sensor

binary_sensor:
  - platform: gpio
    id: dial_button
    pin:
      number: GPIO42
      mode:
        input: true
        pullup: true
      inverted: true
    on_click:
      then:
        - lambda: |-
            // Wake screen on button press
            if (id(screen_sleeping)) {
              id(screen_sleeping) = false;
              id(lcd_backlight).turn_on().set_brightness(1.0f).perform();
              return;  // swallow this press so it doesn't activate a button
            }

  - platform: template
    name: "WiFi Connected"
    id: wifi_connected_bin
    device_class: "connectivity"
    lambda: 'return id(wifi_connected);'

  - platform: template
    name: "Rain Sensor"
    id: rain_sensor_entity
    icon: "mdi:weather-rainy"
    device_class: "moisture"
    lambda: 'return false;'

# ──────────────────────────────────────────────
# Text Sensors (read-only)
# ──────────────────────────────────────────────

text_sensor:
  - platform: version
    name: "ESPHome Version"

  - platform: wifi_info
    ip_address:
      name: "IP Address"
    ssid:
      name: "Connected SSID"

  - platform: template
    name: "Delta Latency"
    id: delta_latency_entity
    icon: "mdi:delta"
    update_interval: never

  - platform: template
    name: "Last Delta Latency"
    id: last_delta_latency_entity
    icon: "mdi:history"
    update_interval: never

# ──────────────────────────────────────────────
# Template Text Entities (writable from HA)
# ──────────────────────────────────────────────

text:
  - platform: template
    name: "Valve Status"
    id: valve_status_entity
    icon: "mdi:valve"
    optimistic: true
    min_length: 0
    max_length: 64
    mode: text
    initial_value: "Idle"
    on_value:
      then:
        - lambda: |-
            lv_label_set_text(id(lbl_valve_status), x.c_str());
            // Color based on status
            if (x.find("Active") != std::string::npos) {
              lv_obj_set_style_text_color(id(lbl_valve_status), lv_color_hex(0x2979FF), 0);
              // Extract zone number for active zone display
              std::string zone_num = "--";
              for (size_t i = 0; i < x.find("Active"); i++) {
                if (isdigit(x[i])) {
                  size_t start = i;
                  while (i < x.size() && isdigit(x[i])) i++;
                  zone_num = x.substr(start, i - start);
                  break;
                }
              }
              lv_label_set_text(id(lbl_big_zone), zone_num.c_str());
              // Auto-show active zone page
              if (!id(zone_active_showing)) {
                id(zone_active_showing) = true;
                lv_scr_load(id(page_active_zone)->obj);
              }
            } else if (x == "Idle" || x == "System Ready") {
              lv_obj_set_style_text_color(id(lbl_valve_status), lv_color_hex(0x00E676), 0);
              if (id(zone_active_showing)) {
                id(zone_active_showing) = false;
                lv_scr_load(id(page_status)->obj);
              }
            } else if (x.find("Rain") != std::string::npos) {
              lv_obj_set_style_text_color(id(lbl_valve_status), lv_color_hex(0x2979FF), 0);
            } else if (x == "Paused") {
              lv_obj_set_style_text_color(id(lbl_valve_status), lv_color_hex(0xFFAB00), 0);
            } else {
              lv_obj_set_style_text_color(id(lbl_valve_status), lv_color_hex(0xFFFFFF), 0);
            }

  - platform: template
    name: "Time Remaining"
    id: time_remaining_entity
    icon: "mdi:timer-sand"
    optimistic: true
    min_length: 0
    max_length: 16
    mode: text
    initial_value: "--"
    on_value:
      then:
        - lambda: |-
            // Parse "Xh Ym Zs", "Xm Ys", or "Xs" into total seconds
            // and start the local countdown on the FIRST value received per run
            if (x == "--" || x == "0m 0s" || x.empty()) return;
            int hours = 0, mins = 0, secs = 0;
            const char* p = x.c_str();
            while (*p) {
              if (isdigit(*p)) {
                int val = 0;
                while (isdigit(*p)) { val = val * 10 + (*p - '0'); p++; }
                if (*p == 'h') { hours = val; p++; }
                else if (*p == 'm') { mins = val; p++; }
                else if (*p == 's') { secs = val; p++; }
              } else {
                p++;
              }
            }
            int total_secs = hours * 3600 + mins * 60 + secs;
            if (total_secs <= 0) return;
            // Only start countdown if not already running (first push starts it)
            if (!id(countdown_running)) {
              // Apply last delta correction
              std::string last_d = id(last_delta_latency_entity).state;
              if (!last_d.empty() && last_d != "0") {
                int correction = atoi(last_d.c_str());
                total_secs -= correction;
                if (total_secs < 0) total_secs = 0;
              }
              id(countdown_total) = total_secs;
              id(countdown_remaining) = total_secs;
              id(countdown_running) = true;
              // Update display immediately
              char buf[16];
              int h = total_secs / 3600;
              int m = (total_secs % 3600) / 60;
              int s = total_secs % 60;
              if (h > 0) {
                snprintf(buf, sizeof(buf), "%d:%02d:%02d", h, m, s);
              } else {
                snprintf(buf, sizeof(buf), "%d:%02d", m, s);
              }
              lv_label_set_text(id(lbl_big_remaining), buf);
              lv_bar_set_value(id(bar_active_progress), 100, LV_ANIM_OFF);
            }

  - platform: template
    name: "Active Zone"
    id: active_zone_entity
    icon: "mdi:sprinkler-variant"
    optimistic: true
    min_length: 0
    max_length: 8
    mode: text
    initial_value: "--"
    on_value:
      then:
        - lambda: |-
            lv_label_set_text(id(lbl_big_zone), x.c_str());

  - platform: template
    name: "Schedule Start Time 1"
    id: sched_time_1_entity
    icon: "mdi:clock-start"
    optimistic: true
    min_length: 0
    max_length: 8
    mode: text
    initial_value: ""
    on_value:
      then:
        - lambda: |-
            id(sched_time_1) = x.empty() ? "--:--" : x;
        - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Start Time 2"
    id: sched_time_2_entity
    icon: "mdi:clock-start"
    optimistic: true
    min_length: 0
    max_length: 8
    mode: text
    initial_value: ""
    on_value:
      then:
        - lambda: |-
            id(sched_time_2) = x.empty() ? "--:--" : x;
        - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Start Time 3"
    id: sched_time_3_entity
    icon: "mdi:clock-start"
    optimistic: true
    min_length: 0
    max_length: 8
    mode: text
    initial_value: ""
    on_value:
      then:
        - lambda: |-
            id(sched_time_3) = x.empty() ? "--:--" : x;
        - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Start Time 4"
    id: sched_time_4_entity
    icon: "mdi:clock-start"
    optimistic: true
    min_length: 0
    max_length: 8
    mode: text
    initial_value: ""
    on_value:
      then:
        - lambda: |-
            id(sched_time_4) = x.empty() ? "--:--" : x;
        - script.execute: refresh_schedule_page

# ──────────────────────────────────────────────
# Template Numbers
# ──────────────────────────────────────────────

number:
  - platform: template
    name: "Zone Count"
    id: zone_count_entity
    icon: "mdi:water"
    min_value: 1
    max_value: 32
    step: 1
    mode: slider
    optimistic: true
    initial_value: 8
    entity_category: config
    set_action:
      - lambda: |-
          id(zone_count) = (int)x;

  # Countdown: HA pushes total seconds once when zone starts, ESP counts down locally
  - platform: template
    name: "Countdown Seconds"
    id: countdown_seconds_entity
    icon: "mdi:timer-sand"
    min_value: 0
    max_value: 86400
    step: 1
    mode: box
    optimistic: true
    initial_value: 0
    set_action:
      - lambda: |-
          int secs = (int)x;
          // Apply last delta correction: positive delta means zone stopped
          // before countdown, so we shorten. Negative means zone ran longer.
          std::string last_d = id(last_delta_latency_entity).state;
          if (!last_d.empty() && last_d != "0") {
            int correction = atoi(last_d.c_str());
            secs -= correction;
            if (secs < 0) secs = 0;
          }
          id(countdown_total) = secs;
          id(countdown_remaining) = secs;
          id(countdown_running) = true;
          // Immediately update the display
          if (secs > 0) {
            char buf[16];
            int h = secs / 3600;
            int m = (secs % 3600) / 60;
            int s = secs % 60;
            if (h > 0) {
              snprintf(buf, sizeof(buf), "%d:%02d:%02d", h, m, s);
            } else {
              snprintf(buf, sizeof(buf), "%d:%02d", m, s);
            }
            lv_label_set_text(id(lbl_big_remaining), buf);
            // Reset progress bar to full
            lv_bar_set_value(id(bar_active_progress), 100, LV_ANIM_OFF);
          }

  # Zone durations (1-32)
  - platform: template
    name: "Zone 1 Duration"
    id: zone_1_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 2 Duration"
    id: zone_2_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 3 Duration"
    id: zone_3_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 4 Duration"
    id: zone_4_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 5 Duration"
    id: zone_5_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 6 Duration"
    id: zone_6_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 7 Duration"
    id: zone_7_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 8 Duration"
    id: zone_8_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 9 Duration"
    id: zone_9_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 10 Duration"
    id: zone_10_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 11 Duration"
    id: zone_11_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 12 Duration"
    id: zone_12_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 13 Duration"
    id: zone_13_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 14 Duration"
    id: zone_14_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 15 Duration"
    id: zone_15_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 16 Duration"
    id: zone_16_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 17 Duration"
    id: zone_17_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 18 Duration"
    id: zone_18_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 19 Duration"
    id: zone_19_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 20 Duration"
    id: zone_20_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 21 Duration"
    id: zone_21_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 22 Duration"
    id: zone_22_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 23 Duration"
    id: zone_23_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 24 Duration"
    id: zone_24_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 25 Duration"
    id: zone_25_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 26 Duration"
    id: zone_26_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 27 Duration"
    id: zone_27_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 28 Duration"
    id: zone_28_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 29 Duration"
    id: zone_29_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 30 Duration"
    id: zone_30_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 31 Duration"
    id: zone_31_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2
  - platform: template
    name: "Zone 32 Duration"
    id: zone_32_dur_entity
    icon: "mdi:timer"
    min_value: 1
    max_value: 60
    step: 1
    mode: slider
    optimistic: true
    initial_value: 2

# ──────────────────────────────────────────────
# Template Switches
# ──────────────────────────────────────────────

switch:
  - platform: template
    name: "Start Stop"
    id: main_switch_entity
    icon: "mdi:play-pause"
    optimistic: true
    restore_mode: DISABLED

  - platform: template
    name: "Auto Advance"
    id: auto_advance_entity
    icon: "mdi:skip-next"
    optimistic: true
    restore_mode: DISABLED

  - platform: template
    name: "Schedule Enabled"
    id: schedule_enabled_entity
    icon: "mdi:calendar-check"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(sched_enabled) = true;'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_enabled) = false;'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Monday"
    id: day_mon_entity
    icon: "mdi:calendar"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(sched_days) |= (1 << 0);'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_days) &= ~(1 << 0);'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Tuesday"
    id: day_tue_entity
    icon: "mdi:calendar"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(sched_days) |= (1 << 1);'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_days) &= ~(1 << 1);'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Wednesday"
    id: day_wed_entity
    icon: "mdi:calendar"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(sched_days) |= (1 << 2);'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_days) &= ~(1 << 2);'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Thursday"
    id: day_thu_entity
    icon: "mdi:calendar"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(sched_days) |= (1 << 3);'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_days) &= ~(1 << 3);'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Friday"
    id: day_fri_entity
    icon: "mdi:calendar"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(sched_days) |= (1 << 4);'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_days) &= ~(1 << 4);'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Saturday"
    id: day_sat_entity
    icon: "mdi:calendar"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(sched_days) |= (1 << 5);'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_days) &= ~(1 << 5);'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Schedule Sunday"
    id: day_sun_entity
    icon: "mdi:calendar"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(sched_days) |= (1 << 6);'
      - script.execute: refresh_schedule_page
    on_turn_off:
      - lambda: 'id(sched_days) &= ~(1 << 6);'
      - script.execute: refresh_schedule_page

  - platform: template
    name: "Use 12 Hour Format"
    id: use_12hour_entity
    icon: "mdi:clock-time-four"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(use_12hour) = true;'
    on_turn_off:
      - lambda: 'id(use_12hour) = false;'

  - platform: template
    name: "Sync Needed"
    id: sync_needed_entity
    icon: "mdi:sync-alert"
    optimistic: true
    restore_mode: ALWAYS_ON

  # Zone switches (1-32)
  - platform: template
    name: "Zone 1"
    id: zone_1_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 0);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 0);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 2"
    id: zone_2_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 1);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 1);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 3"
    id: zone_3_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 2);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 2);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 4"
    id: zone_4_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 3);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 3);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 5"
    id: zone_5_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 4);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 4);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 6"
    id: zone_6_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 5);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 5);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 7"
    id: zone_7_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 6);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 6);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 8"
    id: zone_8_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 7);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 7);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 9"
    id: zone_9_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 8);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 8);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 10"
    id: zone_10_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 9);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 9);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 11"
    id: zone_11_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 10);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 10);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 12"
    id: zone_12_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 11);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 11);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 13"
    id: zone_13_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 12);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 12);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 14"
    id: zone_14_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 13);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 13);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 15"
    id: zone_15_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 14);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 14);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 16"
    id: zone_16_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 15);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 15);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 17"
    id: zone_17_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 16);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 16);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 18"
    id: zone_18_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 17);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 17);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 19"
    id: zone_19_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 18);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 18);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 20"
    id: zone_20_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 19);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 19);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 21"
    id: zone_21_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 20);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 20);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 22"
    id: zone_22_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 21);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 21);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 23"
    id: zone_23_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 22);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 22);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 24"
    id: zone_24_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 23);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 23);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 25"
    id: zone_25_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 24);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 24);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 26"
    id: zone_26_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 25);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 25);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 27"
    id: zone_27_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 26);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 26);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 28"
    id: zone_28_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 27);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 27);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 29"
    id: zone_29_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 28);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 28);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 30"
    id: zone_30_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 29);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 29);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 31"
    id: zone_31_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 30);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 30);'
      - script.execute: refresh_zone_buttons
  - platform: template
    name: "Zone 32"
    id: zone_32_switch
    icon: "mdi:sprinkler"
    optimistic: true
    restore_mode: DISABLED
    on_turn_on:
      - lambda: 'id(zone_states) |= (1u << 31);'
      - script.execute: refresh_zone_buttons
    on_turn_off:
      - lambda: 'id(zone_states) &= ~(1u << 31);'
      - script.execute: refresh_zone_buttons

# ──────────────────────────────────────────────
# Buttons (one-shot actions)
# ──────────────────────────────────────────────

button:
  - platform: template
    name: "Pause"
    id: pause_entity
    icon: "mdi:pause"

  - platform: template
    name: "Auto Detect Zones"
    id: auto_detect_entity
    icon: "mdi:magnify"
    entity_category: config

  - platform: restart
    name: "Restart"

# ──────────────────────────────────────────────
# Scripts
# ──────────────────────────────────────────────

script:
  # Helper: toggle a zone switch by number (1-32)
  - id: toggle_zone
    parameters:
      zone_num: int
    then:
      - lambda: |-
          esphome::template_::TemplateSwitch* sw[] = {
            id(zone_1_switch), id(zone_2_switch), id(zone_3_switch), id(zone_4_switch),
            id(zone_5_switch), id(zone_6_switch), id(zone_7_switch), id(zone_8_switch),
            id(zone_9_switch), id(zone_10_switch), id(zone_11_switch), id(zone_12_switch),
            id(zone_13_switch), id(zone_14_switch), id(zone_15_switch), id(zone_16_switch),
            id(zone_17_switch), id(zone_18_switch), id(zone_19_switch), id(zone_20_switch),
            id(zone_21_switch), id(zone_22_switch), id(zone_23_switch), id(zone_24_switch),
            id(zone_25_switch), id(zone_26_switch), id(zone_27_switch), id(zone_28_switch),
            id(zone_29_switch), id(zone_30_switch), id(zone_31_switch), id(zone_32_switch)
          };
          if (zone_num >= 1 && zone_num <= 32) sw[zone_num - 1]->toggle();

  # Helper: turn on a zone switch by number (1-32)
  - id: turn_on_zone
    parameters:
      zone_num: int
    then:
      - lambda: |-
          esphome::template_::TemplateSwitch* sw[] = {
            id(zone_1_switch), id(zone_2_switch), id(zone_3_switch), id(zone_4_switch),
            id(zone_5_switch), id(zone_6_switch), id(zone_7_switch), id(zone_8_switch),
            id(zone_9_switch), id(zone_10_switch), id(zone_11_switch), id(zone_12_switch),
            id(zone_13_switch), id(zone_14_switch), id(zone_15_switch), id(zone_16_switch),
            id(zone_17_switch), id(zone_18_switch), id(zone_19_switch), id(zone_20_switch),
            id(zone_21_switch), id(zone_22_switch), id(zone_23_switch), id(zone_24_switch),
            id(zone_25_switch), id(zone_26_switch), id(zone_27_switch), id(zone_28_switch),
            id(zone_29_switch), id(zone_30_switch), id(zone_31_switch), id(zone_32_switch)
          };
          if (zone_num >= 1 && zone_num <= 32) sw[zone_num - 1]->turn_on();

  # Helper: set zone duration by zone number
  - id: set_zone_duration
    parameters:
      zone_num: int
      duration_val: int
    then:
      - lambda: |-
          esphome::template_::TemplateNumber* nums[] = {
            id(zone_1_dur_entity), id(zone_2_dur_entity), id(zone_3_dur_entity), id(zone_4_dur_entity),
            id(zone_5_dur_entity), id(zone_6_dur_entity), id(zone_7_dur_entity), id(zone_8_dur_entity),
            id(zone_9_dur_entity), id(zone_10_dur_entity), id(zone_11_dur_entity), id(zone_12_dur_entity),
            id(zone_13_dur_entity), id(zone_14_dur_entity), id(zone_15_dur_entity), id(zone_16_dur_entity),
            id(zone_17_dur_entity), id(zone_18_dur_entity), id(zone_19_dur_entity), id(zone_20_dur_entity),
            id(zone_21_dur_entity), id(zone_22_dur_entity), id(zone_23_dur_entity), id(zone_24_dur_entity),
            id(zone_25_dur_entity), id(zone_26_dur_entity), id(zone_27_dur_entity), id(zone_28_dur_entity),
            id(zone_29_dur_entity), id(zone_30_dur_entity), id(zone_31_dur_entity), id(zone_32_dur_entity)
          };
          if (zone_num >= 1 && zone_num <= 32) {
            auto call = nums[zone_num - 1]->make_call();
            call.set_value(duration_val);
            call.perform();
          }

  # Helper: get zone duration by zone number (returns value to slider)
  - id: load_zone_duration
    parameters:
      zone_num: int
    then:
      - lambda: |-
          esphome::template_::TemplateNumber* nums[] = {
            id(zone_1_dur_entity), id(zone_2_dur_entity), id(zone_3_dur_entity), id(zone_4_dur_entity),
            id(zone_5_dur_entity), id(zone_6_dur_entity), id(zone_7_dur_entity), id(zone_8_dur_entity),
            id(zone_9_dur_entity), id(zone_10_dur_entity), id(zone_11_dur_entity), id(zone_12_dur_entity),
            id(zone_13_dur_entity), id(zone_14_dur_entity), id(zone_15_dur_entity), id(zone_16_dur_entity),
            id(zone_17_dur_entity), id(zone_18_dur_entity), id(zone_19_dur_entity), id(zone_20_dur_entity),
            id(zone_21_dur_entity), id(zone_22_dur_entity), id(zone_23_dur_entity), id(zone_24_dur_entity),
            id(zone_25_dur_entity), id(zone_26_dur_entity), id(zone_27_dur_entity), id(zone_28_dur_entity),
            id(zone_29_dur_entity), id(zone_30_dur_entity), id(zone_31_dur_entity), id(zone_32_dur_entity)
          };
          if (zone_num >= 1 && zone_num <= 32) {
            float val = nums[zone_num - 1]->state;
            if (std::isnan(val)) val = 2;
            lv_slider_set_value(id(slider_duration), (int)val, LV_ANIM_OFF);
            char buf[16];
            snprintf(buf, sizeof(buf), "%d min", (int)val);
            lv_label_set_text(id(lbl_dur_value), buf);
          }

  # Helper: refresh zone page buttons
  - id: refresh_zone_buttons
    then:
      - lambda: |-
          int offset = id(zone_page_offset);
          int zc = id(zone_count);
          lv_obj_t *btns[] = {id(btn_zone_1), id(btn_zone_2), id(btn_zone_3), id(btn_zone_4)};
          lv_obj_t *lbls[] = {id(lbl_zone_1), id(lbl_zone_2), id(lbl_zone_3), id(lbl_zone_4)};
          for (int i = 0; i < 4; i++) {
            int zone_num = offset + i + 1;
            if (zone_num <= zc) {
              lv_obj_clear_flag(btns[i], LV_OBJ_FLAG_HIDDEN);
              char buf[12];
              snprintf(buf, sizeof(buf), "Zone %d", zone_num);
              lv_label_set_text(lbls[i], buf);
              bool active = (id(zone_states) >> (zone_num - 1)) & 1;
              if (active) {
                lv_obj_set_style_bg_color(btns[i], lv_color_hex(0x2979FF), 0);
                lv_obj_set_style_text_color(lbls[i], lv_color_hex(0xFFFFFF), 0);
              } else {
                lv_obj_set_style_bg_color(btns[i], lv_color_hex(0x1A1A1A), 0);
                lv_obj_set_style_border_color(btns[i], lv_color_hex(0x00E676), 0);
                lv_obj_set_style_text_color(lbls[i], lv_color_hex(0x00E676), 0);
              }
            } else {
              lv_obj_add_flag(btns[i], LV_OBJ_FLAG_HIDDEN);
            }
          }
          char title[16];
          int last = offset + 4;
          if (last > zc) last = zc;
          snprintf(title, sizeof(title), "ZONES %d-%d", offset + 1, last);
          lv_label_set_text(id(lbl_zone_page_title), title);
          // Hide/show PREV/NEXT based on zone count
          if (zc <= 4) {
            lv_obj_add_flag(id(btn_zone_prev), LV_OBJ_FLAG_HIDDEN);
            lv_obj_add_flag(id(btn_zone_next), LV_OBJ_FLAG_HIDDEN);
          } else {
            lv_obj_clear_flag(id(btn_zone_prev), LV_OBJ_FLAG_HIDDEN);
            lv_obj_clear_flag(id(btn_zone_next), LV_OBJ_FLAG_HIDDEN);
          }
          // Auto-show/hide active zone page based on zone states
          if (id(zone_states) != 0 && !id(zone_active_showing)) {
            // Find first active zone number for display
            for (int i = 0; i < 32; i++) {
              if ((id(zone_states) >> i) & 1) {
                char zn[4];
                snprintf(zn, sizeof(zn), "%d", i + 1);
                lv_label_set_text(id(lbl_big_zone), zn);
                break;
              }
            }
            // Wake screen if sleeping — zone is running
            if (id(screen_sleeping)) {
              id(screen_sleeping) = false;
              id(lcd_backlight).turn_on().set_brightness(1.0f).perform();
            }
            id(zone_active_showing) = true;
            lv_scr_load(id(page_active_zone)->obj);
          } else if (id(zone_states) == 0 && id(zone_active_showing)) {
            id(zone_active_showing) = false;
            lv_scr_load(id(page_status)->obj);
            // Capture delta: countdown_remaining at zone stop
            // Positive = zone stopped early (shorten next time)
            // Negative = zone ran past countdown (lengthen next time)
            int delta = id(countdown_remaining);
            char dbuf[16];
            snprintf(dbuf, sizeof(dbuf), "%d", delta);
            id(delta_latency_entity).publish_state(dbuf);
            id(last_delta_latency_entity).publish_state(dbuf);
            // Stop countdown and reset
            id(countdown_running) = false;
            id(countdown_remaining) = 0;
            id(countdown_total) = 0;
          }

  # Helper: refresh schedule page
  - id: refresh_schedule_page
    then:
      - lambda: |-
          // Update enabled label
          if (id(sched_enabled)) {
            lv_label_set_text(id(lbl_sched_enabled), "ON");
            lv_obj_set_style_text_color(id(lbl_sched_enabled), lv_color_hex(0x00E676), 0);
          } else {
            lv_label_set_text(id(lbl_sched_enabled), "OFF");
            lv_obj_set_style_text_color(id(lbl_sched_enabled), lv_color_hex(0xFF3D00), 0);
          }
          // Update day buttons
          lv_obj_t* day_btns[] = {id(btn_day_mon), id(btn_day_tue), id(btn_day_wed),
                                   id(btn_day_thu), id(btn_day_fri), id(btn_day_sat), id(btn_day_sun)};
          lv_obj_t* day_lbls[] = {lv_obj_get_child(day_btns[0], 0), lv_obj_get_child(day_btns[1], 0),
                                   lv_obj_get_child(day_btns[2], 0), lv_obj_get_child(day_btns[3], 0),
                                   lv_obj_get_child(day_btns[4], 0), lv_obj_get_child(day_btns[5], 0),
                                   lv_obj_get_child(day_btns[6], 0)};
          for (int i = 0; i < 7; i++) {
            bool on = (id(sched_days) >> i) & 1;
            if (on) {
              lv_obj_set_style_bg_color(day_btns[i], lv_color_hex(0x00E676), 0);
              lv_obj_set_style_text_color(day_lbls[i], lv_color_hex(0x000000), 0);
            } else {
              lv_obj_set_style_bg_color(day_btns[i], lv_color_hex(0x333333), 0);
              lv_obj_set_style_text_color(day_lbls[i], lv_color_hex(0xFFFFFF), 0);
            }
          }
          // Update time labels
          char buf[32];
          snprintf(buf, sizeof(buf), "1: %s", id(sched_time_1).c_str());
          lv_label_set_text(id(lbl_sched_t1), buf);
          snprintf(buf, sizeof(buf), "2: %s", id(sched_time_2).c_str());
          lv_label_set_text(id(lbl_sched_t2), buf);
          snprintf(buf, sizeof(buf), "3: %s", id(sched_time_3).c_str());
          lv_label_set_text(id(lbl_sched_t3), buf);
          snprintf(buf, sizeof(buf), "4: %s", id(sched_time_4).c_str());
          lv_label_set_text(id(lbl_sched_t4), buf);

  # Helper: update time editor display
  - id: update_time_display
    then:
      - lambda: |-
          int h = id(time_edit_hour);
          int m = id(time_edit_minute);
          char buf[16];
          if (id(use_12hour)) {
            int h12 = h % 12;
            if (h12 == 0) h12 = 12;
            const char* ampm = (h < 12) ? "AM" : "PM";
            snprintf(buf, sizeof(buf), "%d:%02d %s", h12, m, ampm);
            // Show AM/PM button
            lv_obj_clear_flag(id(btn_ampm), LV_OBJ_FLAG_HIDDEN);
            lv_label_set_text(id(lbl_ampm), ampm);
          } else {
            snprintf(buf, sizeof(buf), "%02d:%02d", h, m);
            // Hide AM/PM button
            lv_obj_add_flag(id(btn_ampm), LV_OBJ_FLAG_HIDDEN);
          }
          lv_label_set_text(id(lbl_time_display), buf);

# ──────────────────────────────────────────────
# Intervals
# ──────────────────────────────────────────────

interval:
  # Update HA time display on status page every second
  - interval: 1s
    then:
      - lambda: |-
          auto time = id(ha_time).now();
          if (time.is_valid()) {
            char buf[16];
            if (id(use_12hour)) {
              int h12 = time.hour % 12;
              if (h12 == 0) h12 = 12;
              const char* ampm = (time.hour < 12) ? "AM" : "PM";
              snprintf(buf, sizeof(buf), "%d:%02d %s", h12, time.minute, ampm);
            } else {
              snprintf(buf, sizeof(buf), "%02d:%02d", time.hour, time.minute);
            }
            lv_label_set_text(id(lbl_current_time), buf);
          }
          // Local countdown tick — keeps running past 0 to track overshoot
          if (id(countdown_running)) {
            id(countdown_remaining)--;
            int r = id(countdown_remaining);
            char cbuf[16];
            if (r > 0) {
              // Still counting down
              int h = r / 3600;
              int m = (r % 3600) / 60;
              int s = r % 60;
              if (h > 0) {
                snprintf(cbuf, sizeof(cbuf), "%d:%02d:%02d", h, m, s);
              } else {
                snprintf(cbuf, sizeof(cbuf), "%d:%02d", m, s);
              }
              lv_label_set_text(id(lbl_big_remaining), cbuf);
              int total = id(countdown_total);
              if (total > 0) {
                int pct = (r * 100) / total;
                lv_bar_set_value(id(bar_active_progress), pct, LV_ANIM_ON);
              }
            } else {
              // Past zero — zone is running longer than expected
              lv_label_set_text(id(lbl_big_remaining), "0:00");
              lv_bar_set_value(id(bar_active_progress), 0, LV_ANIM_OFF);
            }
          }

  # Idle timeout: return to active zone page after 60s of no interaction
  - interval: 5s
    then:
      - lambda: |-
          std::string az = id(active_zone_entity).state;
          if (az != "--" && !az.empty() && !id(zone_active_showing)) {
            uint32_t idle_ms = lv_disp_get_inactive_time(NULL);
            if (idle_ms >= 60000) {
              id(zone_active_showing) = true;
              lv_scr_load(id(page_active_zone)->obj);
            }
          }
          if (id(zone_active_showing)) {
            uint32_t idle_ms = lv_disp_get_inactive_time(NULL);
            if (idle_ms < 1000) {
              id(zone_active_showing) = false;
              lv_scr_load(id(page_status)->obj);
            }
          }

  # Screen sleep: turn off backlight after 2 minutes of inactivity (skip if zone running)
  - interval: 5s
    then:
      - lambda: |-
          uint32_t idle_ms = lv_disp_get_inactive_time(NULL);
          if (!id(screen_sleeping) && idle_ms >= 120000 && id(zone_states) == 0) {
            id(screen_sleeping) = true;
            id(lcd_backlight).turn_off().perform();
          }

# ──────────────────────────────────────────────
# LVGL UI
# ──────────────────────────────────────────────

lvgl:
  displays:
    - dial_lcd
  touchscreens:
    - touchscreen_id: touch
  encoders:
    - sensor: dial_encoder
      enter_button: dial_button
  color_depth: 16
  buffer_size: 10%
  default_font: montserrat_14
  disp_bg_color: 0x0D0D0D

  theme:
    button:
      focused:
        border_color: 0xFFFFFF
        border_width: 2
    slider:
      focused:
        border_color: 0xFFFFFF
        border_width: 2
      knob:
        edited:
          bg_color: 0xFF3D00

  style_definitions:
    - id: style_btn
      bg_color: 0x00E676
      radius: 8
      text_color: 0x0D0D0D
      pad_all: 6
    - id: style_btn_outline
      bg_color: 0x1A1A1A
      radius: 8
      border_width: 2
      border_color: 0x00E676
      text_color: 0x00E676
      pad_all: 6
    - id: style_btn_red
      bg_color: 0xFF3D00
      radius: 8
      text_color: 0xFFFFFF
      pad_all: 6

  pages:
    # ──────── PAGE: SPLASH ────────
    - id: page_splash
      bg_color: 0x0D0D0D
      bg_opa: COVER
      widgets:
        - image:
            src: img_logo
            align: CENTER
            y: -16
        - label:
            id: lbl_splash_status
            text: "Connecting..."
            text_font: montserrat_12
            text_color: 0x555555
            align: CENTER
            y: 24

    # ──────── PAGE: STATUS (Main Dashboard - Redesigned) ────────
    - id: page_status
      bg_color: 0x0D0D0D
      bg_opa: COVER
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_status));
      widgets:
        - image:
            src: img_logo
            align: CENTER
            y: -66

        # Current time from HA - big centered display
        - label:
            id: lbl_current_time
            text: "--:--"
            text_font: montserrat_28
            text_color: 0xFFFFFF
            align: CENTER
            y: -20

        # Valve status below time
        - label:
            id: lbl_valve_status
            text: "Idle"
            text_font: montserrat_14
            text_color: 0x00E676
            align: CENTER
            y: 10

        # Three nav buttons in a row
        - button:
            id: btn_goto_zones
            x: 16
            y: 148
            width: 66
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "ZONES"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_zones
                    animation: NONE

        - button:
            id: btn_goto_schedule
            x: 87
            y: 148
            width: 66
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "SCHED"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_schedule
                    animation: NONE

        - button:
            id: btn_goto_settings
            x: 158
            y: 148
            width: 66
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "SETUP"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_settings
                    animation: NONE

        - label:
            text: "V${software_version}"
            text_font: montserrat_10
            text_color: 0x444444
            align: BOTTOM_MID
            y: -18

        - label:
            id: lbl_wifi
            text: "WiFi: --"
            text_font: montserrat_10
            text_color: 0x444444
            align: BOTTOM_MID
            y: -6

    # ──────── PAGE: ZONES ────────
    - id: page_zones
      bg_color: 0x0D0D0D
      bg_opa: COVER
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_zones));
          - script.execute: refresh_zone_buttons
      widgets:
        - label:
            id: lbl_zone_page_title
            text: "ZONES 1-4"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 18

        # 2x2 grid of zone buttons
        - button:
            id: btn_zone_1
            x: 24
            y: 38
            width: 92
            height: 34
            styles: style_btn_outline
            widgets:
              - label:
                  id: lbl_zone_1
                  text: "Zone 1"
                  text_font: montserrat_12
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: 'id(last_selected_zone) = id(zone_page_offset) + 1;'
                - script.execute:
                    id: toggle_zone
                    zone_num: !lambda 'return id(zone_page_offset) + 1;'

        - button:
            id: btn_zone_2
            x: 124
            y: 38
            width: 92
            height: 34
            styles: style_btn_outline
            widgets:
              - label:
                  id: lbl_zone_2
                  text: "Zone 2"
                  text_font: montserrat_12
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: 'id(last_selected_zone) = id(zone_page_offset) + 2;'
                - script.execute:
                    id: toggle_zone
                    zone_num: !lambda 'return id(zone_page_offset) + 2;'

        - button:
            id: btn_zone_3
            x: 24
            y: 80
            width: 92
            height: 34
            styles: style_btn_outline
            widgets:
              - label:
                  id: lbl_zone_3
                  text: "Zone 3"
                  text_font: montserrat_12
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: 'id(last_selected_zone) = id(zone_page_offset) + 3;'
                - script.execute:
                    id: toggle_zone
                    zone_num: !lambda 'return id(zone_page_offset) + 3;'

        - button:
            id: btn_zone_4
            x: 124
            y: 80
            width: 92
            height: 34
            styles: style_btn_outline
            widgets:
              - label:
                  id: lbl_zone_4
                  text: "Zone 4"
                  text_font: montserrat_12
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: 'id(last_selected_zone) = id(zone_page_offset) + 4;'
                - script.execute:
                    id: toggle_zone
                    zone_num: !lambda 'return id(zone_page_offset) + 4;'

        # Nav: PREV / NEXT
        - button:
            id: btn_zone_prev
            x: 30
            y: 122
            width: 80
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "< PREV"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    if (id(zone_page_offset) >= 4)
                      id(zone_page_offset) -= 4;
                - script.execute: refresh_zone_buttons

        - button:
            id: btn_zone_next
            x: 130
            y: 122
            width: 80
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "NEXT >"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    if (id(zone_page_offset) + 4 < id(zone_count))
                      id(zone_page_offset) += 4;
                - script.execute: refresh_zone_buttons

        # Bottom row: BACK / TIMER (centered, RUN removed)
        - button:
            id: btn_zones_back
            x: 40
            y: 154
            width: 72
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "BACK"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_status
                    animation: NONE

        - button:
            id: btn_goto_dur
            x: 128
            y: 154
            width: 72
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "TIMER"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_duration
                    animation: NONE

    # ──────── PAGE: DURATION ────────
    - id: page_duration
      bg_color: 0x0D0D0D
      bg_opa: COVER
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_duration));
              char buf[16];
              snprintf(buf, sizeof(buf), "Zone %d", id(dur_selected_zone));
              lv_label_set_text(id(lbl_dur_zone_name), buf);
          - script.execute:
              id: load_zone_duration
              zone_num: !lambda 'return id(dur_selected_zone);'
      widgets:
        - label:
            text: "ZONE DURATION"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 22

        - button:
            id: btn_dur_zone_prev
            x: 30
            y: 44
            width: 40
            height: 28
            styles: style_btn_outline
            widgets:
              - label:
                  text: "<"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    if (id(dur_selected_zone) > 1) {
                      id(dur_selected_zone)--;
                      char buf[16];
                      snprintf(buf, sizeof(buf), "Zone %d", id(dur_selected_zone));
                      lv_label_set_text(id(lbl_dur_zone_name), buf);
                    }
                - script.execute:
                    id: load_zone_duration
                    zone_num: !lambda 'return id(dur_selected_zone);'

        - label:
            id: lbl_dur_zone_name
            text: "Zone 1"
            text_font: montserrat_14
            text_color: 0x00E676
            align: TOP_MID
            y: 48

        - button:
            id: btn_dur_zone_next
            x: 170
            y: 44
            width: 40
            height: 28
            styles: style_btn_outline
            widgets:
              - label:
                  text: ">"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    if (id(dur_selected_zone) < id(zone_count)) {
                      id(dur_selected_zone)++;
                      char buf[16];
                      snprintf(buf, sizeof(buf), "Zone %d", id(dur_selected_zone));
                      lv_label_set_text(id(lbl_dur_zone_name), buf);
                    }
                - script.execute:
                    id: load_zone_duration
                    zone_num: !lambda 'return id(dur_selected_zone);'

        - label:
            id: lbl_dur_value
            text: "2 min"
            text_font: montserrat_28
            text_color: 0xFFFFFF
            align: CENTER
            y: -16

        - slider:
            id: slider_duration
            align: CENTER
            y: 20
            width: 160
            height: 14
            min_value: 1
            max_value: 60
            value: 2
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x00E676
            knob:
              bg_color: 0xFFFFFF
              radius: 7
              width: 14
              height: 14
            on_value:
              then:
                - lvgl.label.update:
                    id: lbl_dur_value
                    text:
                      format: "%d min"
                      args: ['(int)x']

        - button:
            id: btn_dur_set
            align: CENTER
            y: 54
            width: 120
            height: 30
            styles: style_btn
            widgets:
              - label:
                  text: "SET"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - script.execute:
                    id: set_zone_duration
                    zone_num: !lambda 'return id(dur_selected_zone);'
                    duration_val: !lambda 'return lv_slider_get_value(id(slider_duration));'

        - button:
            id: btn_dur_back
            align: BOTTOM_MID
            y: -28
            width: 80
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "< BACK"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_zones
                    animation: NONE

    # ──────── PAGE: SCHEDULE ────────
    - id: page_schedule
      bg_color: 0x0D0D0D
      bg_opa: COVER
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_schedule));
          - script.execute: refresh_schedule_page
      widgets:
        - label:
            text: "SCHEDULE"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 18

        # Enable toggle
        - button:
            id: btn_sched_toggle
            x: 40
            y: 36
            width: 100
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "Enabled:"
                  text_font: montserrat_10
                  align: LEFT_MID
                  x: 4
                  text_color: 0x888888
              - label:
                  id: lbl_sched_enabled
                  text: "OFF"
                  text_font: montserrat_10
                  align: RIGHT_MID
                  x: -4
                  text_color: 0xFF3D00
            on_click:
              then:
                - switch.toggle: schedule_enabled_entity

        # Day of week buttons (7 in a row)
        - button:
            id: btn_day_mon
            x: 22
            y: 66
            width: 26
            height: 24
            radius: 4
            bg_color: 0x333333
            widgets:
              - label:
                  text: "M"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - switch.toggle: day_mon_entity

        - button:
            id: btn_day_tue
            x: 52
            y: 66
            width: 26
            height: 24
            radius: 4
            bg_color: 0x333333
            widgets:
              - label:
                  text: "T"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - switch.toggle: day_tue_entity

        - button:
            id: btn_day_wed
            x: 82
            y: 66
            width: 26
            height: 24
            radius: 4
            bg_color: 0x333333
            widgets:
              - label:
                  text: "W"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - switch.toggle: day_wed_entity

        - button:
            id: btn_day_thu
            x: 112
            y: 66
            width: 26
            height: 24
            radius: 4
            bg_color: 0x333333
            widgets:
              - label:
                  text: "T"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - switch.toggle: day_thu_entity

        - button:
            id: btn_day_fri
            x: 142
            y: 66
            width: 26
            height: 24
            radius: 4
            bg_color: 0x333333
            widgets:
              - label:
                  text: "F"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - switch.toggle: day_fri_entity

        - button:
            id: btn_day_sat
            x: 172
            y: 66
            width: 26
            height: 24
            radius: 4
            bg_color: 0x333333
            widgets:
              - label:
                  text: "S"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - switch.toggle: day_sat_entity

        - button:
            id: btn_day_sun
            x: 202
            y: 66
            width: 26
            height: 24
            radius: 4
            bg_color: 0x333333
            widgets:
              - label:
                  text: "S"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - switch.toggle: day_sun_entity

        # Start time displays (2x2)
        - label:
            id: lbl_sched_t1
            text: "1: --:--"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 30
            y: 98
        - label:
            id: lbl_sched_t2
            text: "2: --:--"
            text_font: montserrat_12
            text_color: 0xFFFFFF
            x: 130
            y: 98
        - label:
            id: lbl_sched_t3
            text: "3: --:--"
            text_font: montserrat_12
            text_color: 0x888888
            x: 30
            y: 118
        - label:
            id: lbl_sched_t4
            text: "4: --:--"
            text_font: montserrat_12
            text_color: 0x888888
            x: 130
            y: 118

        # Bottom row
        - button:
            id: btn_goto_time_edit
            x: 30
            y: 146
            width: 100
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "EDIT TIMES"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_time_edit
                    animation: NONE

        - button:
            id: btn_sched_back
            x: 140
            y: 146
            width: 80
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "< BACK"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_status
                    animation: NONE

    # ──────── PAGE: TIME EDITOR (Redesigned — HOUR/MINUTE dial select) ────────
    - id: page_time_edit
      bg_color: 0x0D0D0D
      bg_opa: COVER
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_time_edit));
              id(time_edit_mode) = 0;
              // Update title
              char buf[24];
              snprintf(buf, sizeof(buf), "START TIME %d", id(time_edit_slot));
              lv_label_set_text(id(lbl_time_edit_title), buf);
              // Only parse stored time on fresh entry, not when returning from hour/minute sub-pages
              if (!id(time_edit_returning)) {
                std::string current;
                int slot = id(time_edit_slot);
                if (slot == 1) current = id(sched_time_1);
                else if (slot == 2) current = id(sched_time_2);
                else if (slot == 3) current = id(sched_time_3);
                else current = id(sched_time_4);
                if (current.length() >= 5 && current[2] == ':') {
                  id(time_edit_hour) = atoi(current.substr(0, 2).c_str());
                  id(time_edit_minute) = atoi(current.substr(3, 2).c_str());
                } else {
                  id(time_edit_hour) = 6;
                  id(time_edit_minute) = 0;
                }
              }
              id(time_edit_returning) = false;
          - script.execute: update_time_display
      widgets:
        - label:
            id: lbl_time_edit_title
            text: "START TIME 1"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 18

        # Slot selector
        - button:
            id: btn_slot_prev
            x: 40
            y: 36
            width: 40
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: "<"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    if (id(time_edit_slot) > 1) {
                      id(time_edit_slot)--;
                      char buf[24];
                      snprintf(buf, sizeof(buf), "START TIME %d", id(time_edit_slot));
                      lv_label_set_text(id(lbl_time_edit_title), buf);
                      // Load time for new slot
                      std::string current;
                      int slot = id(time_edit_slot);
                      if (slot == 1) current = id(sched_time_1);
                      else if (slot == 2) current = id(sched_time_2);
                      else if (slot == 3) current = id(sched_time_3);
                      else current = id(sched_time_4);
                      if (current.length() >= 5 && current[2] == ':') {
                        id(time_edit_hour) = atoi(current.substr(0, 2).c_str());
                        id(time_edit_minute) = atoi(current.substr(3, 2).c_str());
                      } else {
                        id(time_edit_hour) = 6;
                        id(time_edit_minute) = 0;
                      }
                    }
                - script.execute: update_time_display

        - button:
            id: btn_slot_next
            x: 160
            y: 36
            width: 40
            height: 24
            styles: style_btn_outline
            widgets:
              - label:
                  text: ">"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    if (id(time_edit_slot) < 4) {
                      id(time_edit_slot)++;
                      char buf[24];
                      snprintf(buf, sizeof(buf), "START TIME %d", id(time_edit_slot));
                      lv_label_set_text(id(lbl_time_edit_title), buf);
                      std::string current;
                      int slot = id(time_edit_slot);
                      if (slot == 1) current = id(sched_time_1);
                      else if (slot == 2) current = id(sched_time_2);
                      else if (slot == 3) current = id(sched_time_3);
                      else current = id(sched_time_4);
                      if (current.length() >= 5 && current[2] == ':') {
                        id(time_edit_hour) = atoi(current.substr(0, 2).c_str());
                        id(time_edit_minute) = atoi(current.substr(3, 2).c_str());
                      } else {
                        id(time_edit_hour) = 6;
                        id(time_edit_minute) = 0;
                      }
                    }
                - script.execute: update_time_display

        # Time display (moved up)
        - label:
            id: lbl_time_display
            text: "06:00"
            text_font: montserrat_28
            text_color: 0xFFFFFF
            align: CENTER
            y: -36

        # HOUR and MINUTE select buttons
        - button:
            id: btn_hour_select
            x: 36
            y: 100
            width: 76
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "HOUR"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    id(time_edit_mode) = 1;
                    id(encoder_last_value) = (int)id(dial_encoder).state;
                - lvgl.page.show:
                    id: page_hour_select
                    animation: NONE

        - button:
            id: btn_minute_select
            x: 128
            y: 100
            width: 76
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "MINUTE"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    id(time_edit_mode) = 2;
                    id(encoder_last_value) = (int)id(dial_encoder).state;
                - lvgl.page.show:
                    id: page_minute_select
                    animation: NONE

        # AM/PM toggle (visible only in 12hr mode)
        - button:
            id: btn_ampm
            align: TOP_MID
            y: 130
            width: 60
            height: 22
            styles: style_btn_outline
            widgets:
              - label:
                  id: lbl_ampm
                  text: "AM"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lambda: |-
                    // Toggle AM/PM by flipping 12 hours
                    if (id(time_edit_hour) < 12) {
                      id(time_edit_hour) += 12;
                    } else {
                      id(time_edit_hour) -= 12;
                    }
                - script.execute: update_time_display

        # Bottom buttons: SET / CLEAR / BACK
        - button:
            id: btn_time_set
            x: 18
            y: 158
            width: 64
            height: 26
            styles: style_btn
            widgets:
              - label:
                  text: "SET"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - lambda: |-
                    // Always store as 24hr "HH:MM" internally
                    char time_buf[8];
                    snprintf(time_buf, sizeof(time_buf), "%02d:%02d", id(time_edit_hour), id(time_edit_minute));
                    std::string ts = time_buf;
                    int slot = id(time_edit_slot);
                    if (slot == 1) { id(sched_time_1) = ts; auto call = id(sched_time_1_entity).make_call(); call.set_value(ts); call.perform(); }
                    else if (slot == 2) { id(sched_time_2) = ts; auto call = id(sched_time_2_entity).make_call(); call.set_value(ts); call.perform(); }
                    else if (slot == 3) { id(sched_time_3) = ts; auto call = id(sched_time_3_entity).make_call(); call.set_value(ts); call.perform(); }
                    else if (slot == 4) { id(sched_time_4) = ts; auto call = id(sched_time_4_entity).make_call(); call.set_value(ts); call.perform(); }
                    ESP_LOGI("time_edit", "SET time slot %d to %s", slot, ts.c_str());
                - script.execute: update_time_display

        - button:
            id: btn_time_clear
            x: 88
            y: 158
            width: 64
            height: 26
            styles: style_btn_red
            widgets:
              - label:
                  text: "CLEAR"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - lambda: |-
                    int slot = id(time_edit_slot);
                    std::string empty = "";
                    if (slot == 1) { id(sched_time_1) = "--:--"; auto call = id(sched_time_1_entity).make_call(); call.set_value(empty); call.perform(); }
                    else if (slot == 2) { id(sched_time_2) = "--:--"; auto call = id(sched_time_2_entity).make_call(); call.set_value(empty); call.perform(); }
                    else if (slot == 3) { id(sched_time_3) = "--:--"; auto call = id(sched_time_3_entity).make_call(); call.set_value(empty); call.perform(); }
                    else if (slot == 4) { id(sched_time_4) = "--:--"; auto call = id(sched_time_4_entity).make_call(); call.set_value(empty); call.perform(); }
                    id(time_edit_hour) = 6;
                    id(time_edit_minute) = 0;
                - script.execute: update_time_display

        - button:
            id: btn_time_back
            x: 158
            y: 158
            width: 64
            height: 26
            styles: style_btn_outline
            widgets:
              - label:
                  text: "BACK"
                  text_font: montserrat_10
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_schedule
                    animation: NONE

    # ──────── PAGE: HOUR SELECT (dial to change hour) ────────
    - id: page_hour_select
      bg_color: 0x0D0D0D
      bg_opa: COVER
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_hour_sel));
              // Set initial hour display
              char buf[8];
              int h = id(time_edit_hour);
              if (id(use_12hour)) {
                int h12 = h % 12;
                if (h12 == 0) h12 = 12;
                snprintf(buf, sizeof(buf), "%d", h12);
              } else {
                snprintf(buf, sizeof(buf), "%02d", h);
              }
              lv_label_set_text(id(lbl_hour_value), buf);
      widgets:
        - label:
            text: "SELECT HOUR"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 30

        - label:
            id: lbl_hour_value
            text: "6"
            text_font: montserrat_48
            text_color: 0x00E676
            align: CENTER
            y: -16

        - label:
            text: "Rotate dial to change"
            text_font: montserrat_10
            text_color: 0x555555
            align: CENTER
            y: 30

        - button:
            id: btn_hour_confirm
            align: CENTER
            y: 62
            width: 100
            height: 30
            styles: style_btn
            widgets:
              - label:
                  text: "OK"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - lambda: |-
                    id(time_edit_mode) = 0;
                    id(time_edit_returning) = true;
                - lvgl.page.show:
                    id: page_time_edit
                    animation: NONE

    # ──────── PAGE: MINUTE SELECT (dial to change minute) ────────
    - id: page_minute_select
      bg_color: 0x0D0D0D
      bg_opa: COVER
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_minute_sel));
              // Set initial minute display
              char buf[8];
              snprintf(buf, sizeof(buf), "%02d", id(time_edit_minute));
              lv_label_set_text(id(lbl_minute_value), buf);
      widgets:
        - label:
            text: "SELECT MINUTE"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 30

        - label:
            id: lbl_minute_value
            text: "00"
            text_font: montserrat_48
            text_color: 0x00E676
            align: CENTER
            y: -16

        - label:
            text: "Rotate dial to change"
            text_font: montserrat_10
            text_color: 0x555555
            align: CENTER
            y: 30

        - button:
            id: btn_minute_confirm
            align: CENTER
            y: 62
            width: 100
            height: 30
            styles: style_btn
            widgets:
              - label:
                  text: "OK"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0x0D0D0D
            on_click:
              then:
                - lambda: |-
                    id(time_edit_mode) = 0;
                    id(time_edit_returning) = true;
                - lvgl.page.show:
                    id: page_time_edit
                    animation: NONE

    # ──────── PAGE: SETTINGS (12/24hr toggle + firmware version) ────────
    - id: page_settings
      bg_color: 0x0D0D0D
      bg_opa: COVER
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_settings));
              // Update 12hr toggle label
              if (id(use_12hour)) {
                lv_label_set_text(id(lbl_12hr_toggle), "12 HR");
              } else {
                lv_label_set_text(id(lbl_12hr_toggle), "24 HR");
              }
      widgets:
        - label:
            text: "SETTINGS"
            text_font: montserrat_12
            text_color: 0x888888
            align: TOP_MID
            y: 22

        # 12/24 Hour toggle
        - button:
            id: btn_12hr_toggle
            align: CENTER
            y: -20
            width: 140
            height: 30
            styles: style_btn_outline
            widgets:
              - label:
                  id: lbl_12hr_toggle
                  text: "12 HR"
                  text_font: montserrat_12
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - switch.toggle: use_12hour_entity
                - lambda: |-
                    if (id(use_12hour)) {
                      lv_label_set_text(id(lbl_12hr_toggle), "12 HR");
                    } else {
                      lv_label_set_text(id(lbl_12hr_toggle), "24 HR");
                    }

        # Back button
        - button:
            id: btn_settings_back
            align: CENTER
            y: 26
            width: 100
            height: 30
            styles: style_btn_outline
            widgets:
              - label:
                  text: "< BACK"
                  text_font: montserrat_12
                  align: CENTER
                  text_color: 0x00E676
            on_click:
              then:
                - lvgl.page.show:
                    id: page_status
                    animation: NONE


    # ──────── PAGE: ACTIVE ZONE (big display when zone running) ────────
    - id: page_active_zone
      bg_color: 0x0D0D0D
      bg_opa: COVER
      on_load:
        then:
          - lambda: |-
              if (id(enc_indev) != nullptr)
                lv_indev_set_group((lv_indev_t*)id(enc_indev), (lv_group_t*)id(grp_active_zone));
      widgets:
        - label:
            id: lbl_big_zone_title
            text: "ZONE"
            text_font: montserrat_14
            text_color: 0x888888
            align: TOP_MID
            y: 30

        - label:
            id: lbl_big_zone
            text: "--"
            text_font: montserrat_48
            text_color: 0x00E676
            align: CENTER
            y: -20

        - label:
            id: lbl_big_remaining
            text: "--"
            text_font: montserrat_28
            text_color: 0x2979FF
            align: CENTER
            y: 20

        - bar:
            id: bar_active_progress
            align: CENTER
            y: 50
            width: 160
            height: 8
            min_value: 0
            max_value: 100
            value: 0
            bg_color: 0x1A1A1A
            indicator:
              bg_color: 0x00E676

        # Big red STOP button
        - button:
            id: btn_active_stop
            align: CENTER
            y: 80
            width: 120
            height: 40
            styles: style_btn_red
            widgets:
              - label:
                  text: "STOP"
                  text_font: montserrat_14
                  align: CENTER
                  text_color: 0xFFFFFF
            on_click:
              then:
                - lambda: |-
                    // Turn off all active zone switches
                    esphome::template_::TemplateSwitch* sw[] = {
                      id(zone_1_switch), id(zone_2_switch), id(zone_3_switch), id(zone_4_switch),
                      id(zone_5_switch), id(zone_6_switch), id(zone_7_switch), id(zone_8_switch),
                      id(zone_9_switch), id(zone_10_switch), id(zone_11_switch), id(zone_12_switch),
                      id(zone_13_switch), id(zone_14_switch), id(zone_15_switch), id(zone_16_switch),
                      id(zone_17_switch), id(zone_18_switch), id(zone_19_switch), id(zone_20_switch),
                      id(zone_21_switch), id(zone_22_switch), id(zone_23_switch), id(zone_24_switch),
                      id(zone_25_switch), id(zone_26_switch), id(zone_27_switch), id(zone_28_switch),
                      id(zone_29_switch), id(zone_30_switch), id(zone_31_switch), id(zone_32_switch)
                    };
                    for (int i = 0; i < 32; i++) {
                      if ((id(zone_states) >> i) & 1) {
                        sw[i]->turn_off();
                      }
                    }
                - switch.turn_off: main_switch_entity
